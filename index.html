<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風險規則引擎沙盒</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

</head>
<body class="bkgd">
<div class="container-fluid">
    <div class="title-area">
        <h2>風險規則引擎沙盒</h2>
    </div>
    <!-- Bootstrap 浮動按鈕 HTML -->
    <button class="btn btn-primary rounded-circle position-fixed" id="scroll-button"
            style="bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 1030;">
        <i class="bi bi-arrow-down"></i>
    </button>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <!-- Available rules -->
                    <div class="col-md-6">
                        <div class="card h-100 available-rules-card rounded-5">
                            <div class="card-body">
                                <h5 id="rules-title" class="card-title border-bottom pb-2" style="cursor: pointer;" onclick="RuleManager.handleTitleClick()">可用規則</h5>
                                <div class="mb-3">
                                    <div id="button-group" class="btn-group w-100 mb-3" style="display: none;">
                                        <button id="default-btn" class="btn btn-outline-primary active" onclick="RuleManager.applyDefaultRules()">預設決策</button>
                                        <button id="custom-btn" class="btn btn-outline-primary" onclick="RuleManager.clearRules()">自訂決策</button>
                                    </div>
                                </div>
                                <div id="available-rules" class="rules-panel"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Policy selection -->
                    <div class="col-md-6">
                        <div class="card h-100 available-rules-card rounded-5">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">決策配置</h5>
                                    <div class="d-flex align-items-center">
                                        <label for="risk-level" class="form-label me-2 mb-0">預設決策：</label>
                                        <select class="form-select form-select-sm" style="width: auto;" id="risk-level">
                                            <option value="low" >低風險</option>
                                            <option value="medium" selected>中風險</option>
                                            <option value="high">高風險</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="execution-zone" class="drop-zone rules-panel" ondragover="RuleManager.allowDrop(event)" ondrop="RuleManager.drop(event)">
                                    <div class="drop-zone-placeholder" id="zone-placeholder">
                                        <div>拖放規則到此處</div>
                                        <small>從左側拖曳規則到此區域</small>
                                    </div>
                                    <div class="drop-indicator" id="drop-indicator"></div>
                                </div>
                                <button class="btn btn-dark w-100" onclick="RuleManager.executeRules()">
                                    <i class="fas fa-play me-2"></i>執行規則
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 新的 row 用於 Description area -->
                <div class="row mt-3">
                    <!-- Description area -->
                    <div class="col-md-12">
                        <div class="card rounded-5 ">
                            <div class="card-body">
                                <div class="description-area" id="description-area">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle me-2 text-primary mt-1"></i>
                                        <p class="mb-0" id="rule-description">將游標懸停在規則上可查看詳細描述。規則順序決定風險評估優先級。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新增調試日誌區域 -->
<!--            <div class="row mt-3">-->
<!--                <div class="col-md-12">-->
<!--                    <div class="card rounded-5">-->
<!--                        <div class="card-body">-->
<!--                            <h5 class="card-title">調試日誌</h5>-->
<!--                            <div class="form-check mb-2">-->
<!--                                <input class="form-check-input" type="checkbox" value="" id="enable-debug" checked>-->
<!--                                <label class="form-check-label" for="enable-debug">-->
<!--                                    啟用詳細調試日誌-->
<!--                                </label>-->
<!--                            </div>-->
<!--                            <div id="debug-log" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 12px;"></div>-->
<!--                            <button class="btn btn-sm btn-secondary mt-2" onclick="clearDebugLog()">清除日誌</button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

            <!-- Transaction Table -->
            <div class="col-md-6">
                <div class="card rounded-5 ">
                    <div class="card-body">
                        <div class="table-responsive fixed-width-container">
                            <table class="table transaction-table">
                                <thead>
                                <tr>
                                    <th>狀態</th>
                                    <th>卡號</th>
                                    <th>時間</th>
                                    <th>地區</th>
                                    <th class="text-end">金額</th>
                                    <th>MCC</th>
                                    <th class="text-end">偽冒設備</th>
                                    <th class="text-end">卡號異常</th>
                                    <th class="text-end">卡號測試</th>
                                    <th>VPN</th>
                                    <th>Tor</th>
                                    <th>Webdriver</th>
                                    <th>命中規則</th>
                                </tr>
                                </thead>
                                <tbody id="transaction-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <!-- Charts -->
    <div class="row m-0">
        <div class="container-fluid">
            <div class="card rounded-5 mt-3 p-0">
                <div class="card-body">
                    <!-- <h5 class="card-title mb-3">交易地區分佈</h5> -->
                    <div id="world-map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>

        </div>
        <div class="container-fluid">
            <div class="row mt-3">
                <!-- 圓餅圖 - 左側1/4 -->
                <div class="col-md-3 ">
                    <div class=" card rounded-5 h-100">
                        <div class="card-body">
                            <!-- <h5 class="card-title mb-3">交易風險分佈</h5> -->
                            <div id="risk-pie-chart" style="height: 350px; width: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- 柱狀圖 - 右側3/4 -->
                <div class="col-md-9">
                    <div class=" card rounded-5 h-100">
                        <div class="card-body">
                            <!-- <h5 class="card-title mb-3">交易風險時間分佈</h5> -->
                            <div id="hourly-risk-chart" style="height: 350px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>
<script>
    // 調試日誌函數
    function debugLog(message, level = 'info') {
        const enableDebug = document.getElementById('enable-debug')?.checked;
        if (!enableDebug) return;

        const logPanel = document.getElementById('debug-log');
        if (!logPanel) return;

        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.style.marginBottom = '2px';
        logEntry.style.color = level === 'error' ? 'red' : level === 'warning' ? 'orange' : level === 'success' ? 'green' : 'black';
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logPanel.appendChild(logEntry);
        logPanel.scrollTop = logPanel.scrollHeight;
    }

    function clearDebugLog() {
        const logPanel = document.getElementById('debug-log');
        if (logPanel) logPanel.innerHTML = '';
    }

    // 工具函數模塊
    const Utils = {
        getRandomTime(minHoursAgo = 0, maxHoursAgo = 48) {
            const now = new Date();
            const hoursAgo = Math.random() * (maxHoursAgo - minHoursAgo) + minHoursAgo;
            return new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);
        },

        formatDateTime(date) {
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            if (!(dateObj instanceof Date) || isNaN(dateObj)) {
                console.warn('Invalid date:', date);
                return 'Invalid Date';
            }
            return dateObj.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
        },

            isWithin24Hours(timestamp) {
                const now = new Date();
                const txTime = new Date(timestamp);
                return (now - txTime) / (1000 * 60 * 60) <= 24;
            },

            hasMultipleCountriesIn15Min(tx, transactions) {
                const txTime = new Date(tx.timestamp);
                const countries = new Set(
                    transactions
                        .filter(t => t. card === tx.card)
                        .filter(t => Math.abs((txTime - new Date(t.timestamp)) / (1000 * 60)) <= 15)
                        .map(t => t.countryCode)
                );
                return countries.size > 1;
            },

            addLog(message) {
                const logPanel = document.getElementById('log-panel');
                if (!logPanel) {
                    console.warn('Log panel not initialized:', message);
                    return;
                }
                const logEntry = document.createElement('div');
                logEntry.textContent = `> ${message}`;
                logPanel.appendChild(logEntry);
                logPanel.scrollTop = logPanel.scrollHeight;
            },

            clearLog() {
                const logPanel = document.getElementById('log-panel');
                if (logPanel) logPanel.innerHTML = '';
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        };

        // 數據定義
        const Data = {
             countryMap: {
                '158': '臺灣', '156': '中國', '408': '朝鮮', '004': '阿富汗', '116': '柬埔寨',
                '840': '美國', '392': '日本', '702': '新加坡', '276': '德國', '250': '法國',
                '036': '澳洲', '826': '英國'
            },

            countryEChartsMap: {
                '156': 'China', '344': 'China', '158': 'Taiwan', '392': 'Japan', '408': 'North Korea',
                '124': 'Canada', '840': 'United States of America', '276': 'Germany', '826': 'United Kingdom',
                '702': 'Singapore', '804': 'Ukraine', '036': 'Australia', '250': 'France', '356': 'India',
                '360': 'Indonesia', '410': 'South Korea', '458': 'Malaysia', '484': 'Mexico', '643': 'Russia',
                '764': 'Thailand', '704': 'Vietnam', '496': 'Mongolia', '608': 'Philippines', '418': 'Laos',
                '104': 'Myanmar', '116': 'Cambodia', '096': 'Brunei', '398': 'Kazakhstan', '795': 'Turkmenistan',
                '860': 'Uzbekistan', '762': 'Tajikistan', '417': 'Kyrgyzstan', '051': 'Armenia', '031': 'Azerbaijan',
                '268': 'Georgia', '368': 'Iraq', '364': 'Iran', '682': 'Saudi Arabia', '784': 'United Arab Emirates',
                '634': 'Qatar', '414': 'Kuwait', '512': 'Oman', '887': 'Yemen', '760': 'Syria', '422': 'Lebanon',
                '400': 'Jordan', '376': 'Israel', '586': 'Pakistan', '004': 'Afghanistan', '050': 'Bangladesh',
                '144': 'Sri Lanka', '524': 'Nepal', '203': 'Czech Republic', '348': 'Hungary', '616': 'Poland',
                '040': 'Austria', '380': 'Italy', '756': 'Switzerland', '724': 'Spain', '620': 'Portugal',
                '056': 'Belgium', '528': 'Netherlands', '578': 'Norway', '752': 'Sweden', '246': 'Finland',
                '208': 'Denmark', '372': 'Ireland', '300': 'Greece', '642': 'Romania', '100': 'Bulgaria',
                '191': 'Croatia', '705': 'Slovenia', '440': 'Lithuania', '428': 'Latvia', '233': 'Estonia',
                '112': 'Belarus', '710': 'South Africa', '404': 'Kenya', '231': 'Ethiopia', '818': 'Egypt',
                '504': 'Morocco', '788': 'Tunisia', '012': 'Algeria', '288': 'Ghana', '566': 'Nigeria',
                '032': 'Argentina', '076': 'Brazil', '170': 'Colombia', '604': 'Peru', '152': 'Chile',
                '862': 'Venezuela', '218': 'Ecuador', '068': 'Bolivia', '600': 'Paraguay', '858': 'Uruguay'
            },


            rules: [
                {
                    id: '1',
                    text: '15分鐘內，同卡號有驗證成功且無失敗，累積金額<3000',
                    level: 'success',
                    description: '15分鐘內，同卡號有驗證成功且無失敗，累積金額<3000 - 低風險',
                    condition: (tx, allTransactions) => {
                        const txTime = new Date(tx.timestamp);
                        const startTime = new Date(txTime.getTime() - 15 * 60 * 1000);
                        
                        const recent15Txs = allTransactions
                            .filter(t => t.card === tx.card)
                            .filter(t => {
                                const tTime = new Date(t.timestamp);
                                return tTime >= startTime && tTime <= txTime;
                            });
                        
                        const hasSuccess = recent15Txs.some(t => t.verificationResult === '成功');
                        const hasFailure = recent15Txs.some(t => t.verificationResult === '失敗');
                        const totalAmount = recent15Txs.reduce((sum, t) => sum + t.amount, 0) + tx.amount;
                        
                        return hasSuccess && !hasFailure && totalAmount < 3000;
                    },
                    action: 'APPROVE'
                },
                {
                    id: '2',
                    text: '偽冒設備 >0.25、卡號異常>0、卡號測試>0',
                    level: 'success',
                    description: '偽冒設備 >0.25、卡號異常>0、卡號測試>0 - 低風險',
                    condition: tx => tx.fraudDeviceModel > 0.25 && tx.cardAbnormalModel > 0 && tx.cardTestModel > 0,
                    action: 'APPROVE'
                },
                {
                    id: '3',
                    text: '使用 Webdriver',
                    level: 'warning',
                    description: '使用 Webdriver - 中風險',
                    condition: tx => tx.webdriver === true,
                    action: 'REVIEW'
                },
                {
                    id: '4',
                    text: '使用 VPN',
                    level: 'warning',
                    description: '使用 VPN - 中風險',
                    condition: tx => tx.vpn === true,
                    action: 'REVIEW'
                },
                {
                    id: '5',
                    text: '旅遊與娛樂 MCC (T&E transaction)',
                    level: 'warning',
                    description: '旅遊與娛樂 MCC (T&E transaction) - 中風險',
                    condition: tx => ['4111', '4112', '4119', '4121', '4131', '4411', '4511', '5811', '5812', '5813', '7011', '7012', '7032', '7033', '7991', '7992', '7993', '7994', '7995', '7996', '7997', '7998', '7999'].includes(tx.mcc),
                    action: 'REVIEW'
                },
                {
                    id: '6',
                    text: '高風險 MCC (High-brand Risk MCCs)',
                    level: 'warning',
                    description: '高風險 MCC (High-brand Risk MCCs) - 中風險',
                    condition: tx => ['5967', '5968', '5969', '6012', '6051', '7273', '7801', '7802', '9311'].includes(tx.mcc),
                    action: 'REVIEW'
                },
                {
                    id: '7',
                    text: '使用 Tor 瀏覽器',
                    level: 'danger',
                    description: '使用 Tor 瀏覽器 - 高風險',
                    condition: tx => tx.tor === true,
                    action: 'BLOCK'
                },
                {
                    id: '8',
                    text: '20分鐘內，同卡號失敗 > 5次',
                    level: 'danger',
                    description: '20分鐘內，同卡號失敗 > 5次 - 高風險',
                    condition: (tx, allTransactions) => {
                        const txTime = new Date(tx.timestamp);
                        const startTime = new Date(txTime.getTime() - 20 * 60 * 1000);
                        
                        const recent20Txs = allTransactions
                            .filter(t => t.card === tx.card)
                            .filter(t => {
                                const tTime = new Date(t.timestamp);
                                return tTime >= startTime && tTime <= txTime;
                            });
                        
                        const failureCount = recent20Txs.filter(t => t.verificationResult === '失敗').length;
                        
                        return failureCount > 5;
                    },
                    action: 'BLOCK'
                }
            ],

            defaultRuleIds: ['8', '7', '6', '5', '4', '3', '2', '1']
        };
        // 交易管理模塊
        const TransactionManager = {
            transactions: [],

            async loadOrGenerateTransactions(count = 200, filePath = './data1.json') {
                // 暫時強制使用生成的數據來測試新欄位
                this.transactions = this.generateTransactions(count);
                
                /*
                // 原始的文件加載邏輯 - 暫時註釋掉
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) {
                        throw new Error ('file is not exist or can not read')
                    }

                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        // 為現有數據添加新欄位
                        this.transactions = data.map(tx => ({
                            ...tx,
                            // 如果新欄位不存在，添加它們
                            mcc: tx.mcc || this.generateMCC(),
                            fraudDeviceModel: tx.fraudDeviceModel !== undefined ? tx.fraudDeviceModel : Math.random(),
                            cardAbnormalModel: tx.cardAbnormalModel !== undefined ? tx.cardAbnormalModel : Math.random() * 2 - 1,
                            cardTestModel: tx.cardTestModel !== undefined ? tx.cardTestModel : Math.random() * 2 - 1,
                            vpn: tx.vpn !== undefined ? tx.vpn : Math.random() < 0.1,
                            tor: tx.tor !== undefined ? tx.tor : Math.random() < 0.05,
                            webdriver: tx.webdriver !== undefined ? tx.webdriver : Math.random() < 0.15,
                            verificationResult: tx.verificationResult || (Math.random() < 0.8 ? '成功' : '失敗')
                        }));

                    } else {
                        this.transactions = this.generateTransactions(count);
                    }
                } catch (error) {
                    this.transactions = this.generateTransactions(count);
                }
                */

                // 記錄地區分佈統計
                const countryStats = new Map();
                    this.transactions.forEach(tx => {
                        countryStats.set(tx.countryCode, (countryStats.get(tx.countryCode) || 0) + 1);
                    });
                    Utils.addLog(`交易生成完成：共 ${this.transactions.length} 筆，涵蓋 ${countryStats.size} 個地區`);
                    const topCountries = Array.from(countryStats.entries())
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                        .join(', ');
                    Utils.addLog(`交易最多的前5個地區: ${topCountries}`);

                    this.transactions.forEach(tx => {
                        if (tx.card.length !== 16) {
                            Utils.addLog(`Invalid card length for transaction ${tx.id}: ${tx.card}`);
                        }
                    });
                this.loadTransactions();
                console.log(this.transactions);
                return this.transactions;
            },

            generateMCC() {
                const mccCodes = [
                    '1520', '1711', '1731', '1740', '1750', '1761', '1771', '1799',
                    '2741', '2791', '2842',
                    '3000', '3001', '3002', '3003', '3004', '3005', '3006', '3007', '3008', '3009',
                    '4111', '4112', '4119', '4121', '4131', '4411', '4511',
                    '5200', '5211', '5231', '5251', '5261', '5271', '5291', '5309', '5310', '5311', '5331', '5399', '5411', '5422', '5441', '5451', '5462', '5499', '5511', '5521', '5531', '5532', '5533', '5541', '5542', '5551', '5561', '5571', '5592', '5598', '5599', '5611', '5621', '5631', '5641', '5651', '5655', '5661', '5681', '5691', '5697', '5698', '5699', '5712', '5713', '5714', '5718', '5719', '5722', '5732', '5733', '5734', '5735', '5811', '5812', '5813', '5814', '5815', '5816', '5817', '5818', '5912', '5921', '5931', '5932', '5933', '5937', '5940', '5941', '5942', '5943', '5944', '5945', '5946', '5947', '5948', '5949', '5950', '5960', '5962', '5963', '5964', '5965', '5966', '5967', '5968', '5969', '5970', '5971', '5972', '5973', '5975', '5976', '5977', '5978', '5983', '5992', '5993', '5994', '5995', '5996', '5997', '5998', '5999',
                    '6010', '6011', '6012', '6051',
                    '7011', '7012', '7032', '7033', '7210', '7211', '7216', '7217', '7221', '7230', '7251', '7261', '7273', '7276', '7277', '7278', '7296', '7297', '7298', '7299', '7311', '7321', '7322', '7333', '7338', '7339', '7342', '7349', '7361', '7372', '7375', '7379', '7392', '7393', '7394', '7395', '7399', '7511', '7512', '7513', '7519', '7523', '7531', '7534', '7535', '7538', '7542', '7549', '7622', '7623', '7629', '7631', '7641', '7692', '7699', '7800', '7801', '7802', '7829', '7832', '7833', '7841', '7911', '7922', '7929', '7932', '7933', '7941', '7991', '7992', '7993', '7994', '7995', '7996', '7997', '7998', '7999',
                    '8011', '8021', '8031', '8041', '8042', '8043', '8049', '8050', '8062', '8071', '8099', '8111', '8211', '8220', '8241', '8244', '8249', '8299', '8351', '8398', '8641', '8651', '8661', '8675', '8699', '8734', '8911', '8931', '8999',
                    '9211', '9222', '9223', '9311', '9399', '9402', '9700', '9701', '9702', '9751', '9752', '9753'
                ];
                return mccCodes[Math.floor(Math.random() * mccCodes.length)];
            },

            generateTransactions(count = 200) {
                this.transactions = [];
                const countryCodes = Object.keys(Data.countryMap).concat('158');
                const deviceRiskLevels = [-0.9, -0.8, -0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];
                const bankCardPrefixes = ['4', '5', '3', '6'];
                const amountRanges = [
                    { min: 10, max: 300 }, { min: 301, max: 800 },
                    { min: 801, max: 2000 }, { min: 2001, max: 5000 }
                ];

                // 規則命中機率
                const ruleProbabilities = {
                    '1': 0.05, // 低風險，10% / 2
                    '2': 0.05, // 低風險，10% / 2
                    '3': 0.10, // 中風險，20% / 2
                    '4': 0.10, // 中風險，20% / 2
                    '5': 0.0167, // 高風險，5% / 3
                    '6': 0.005, // 高風險，5% / 3
                    '7': 0.0166, // 高風險，5% / 3
                    'none': 0.67 // 未命中規則
                };

                // 儲存卡號與其交易歷史的映射，用於規則2和規則7
                const cardTransactionMap = new Map();
                // 追蹤規則2和規則 мови7的命中索引
                const rule2or7Indices = [];

                // 輔助函數：根據機率選擇目標規則
                function chooseTargetRule(currentIndex) {
                    // 檢查與最近的規則2或7命中交易的間隔
                    if (rule2or7Indices.length > 0) {
                        const lastRule2or7Index = rule2or7Indices[rule2or7Indices.length - 1];
                        const gap = currentIndex - lastRule2or7Index;
                        if (gap < 3) {
                            // 間隔小於3，禁止命中規則2或7
                            const adjustedProbs = { ...ruleProbabilities, '2': 0, '7': 0 };
                            let total = Object.values(adjustedProbs).reduce((sum, p) => sum + p, 0);
                            for (let key in adjustedProbs) {
                                adjustedProbs[key] /= total; // 重新正規化機率
                            }
                            const rand = Math.random();
                            let cumulative = 0;
                            for (const [ruleId, prob] of Object.entries(adjustedProbs)) {
                                cumulative += prob;
                                if (rand < cumulative) return ruleId;
                            }
                        } else if (gap >= 3 && gap <= 7) {
                            // 間隔在3到7之間，允許命中規則2或7
                            const rand = Math.random();
                            let cumulative = 0;
                            for (const [ruleId, prob] of Object.entries(ruleProbabilities)) {
                                cumulative += prob;
                                if (rand < cumulative) return ruleId;
                            }
                        } else {
                            // 間隔超過7，強制命中規則2或7
                            const forcedRules = { '2': 0.5, '7': 0.5 };
                            const rand = Math.random();
                            let cumulative = 0;
                            for (const [ruleId, prob] of Object.entries(forcedRules)) {
                                cumulative += prob;
                                if (rand < cumulative) return ruleId;
                            }
                        }
                    } else {
                        // 尚未有規則2或7命中，按正常機率選擇
                        const rand = Math.random();
                        let cumulative = 0;
                        for (const [ruleId, prob] of Object.entries(ruleProbabilities)) {
                            cumulative += prob;
                            if (rand < cumulative) return ruleId;
                        }
                    }
                    return 'none'; // 默認未命中
                }

                // 輔助函數：生成符合特定規則的交易
                function generateTransactionForRule(ruleId, card, timestamp, prevTxs) {
                    let amount, countryCode, deviceRisk, isVerified, cumulativeAmount;

                    switch (ruleId) {
                        case '1':
                            // 小金額且設備低風險
                            amount = Math.floor(Math.random() * (300 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels.filter(r => r > 0.3)[Math.floor(Math.random() * deviceRiskLevels.filter(r => r > 0.3).length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        case '2':
                            // 前24小時低風險交易，總金額小於$1000
                            amount = Math.floor(Math.random() * (500 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = true;
                            // 確保卡號有前期低風險交易
                            const prevTx = prevTxs.find(t => t.card === card && t.action === 'APPROVE');
                            cumulativeAmount = prevTx ? prevTx.cumulativeAmount + amount : amount;
                            if (cumulativeAmount >= 1000) cumulativeAmount = 999; // 確保總金額<1000
                            break;
                        case '3':
                            // 設備中風險
                            amount = Math.floor(Math.random() * (5000 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels.filter(r => r >= -0.3 && r < 0.3)[Math.floor(Math.random() * deviceRiskLevels.filter(r => r >= -0.3 && r < 0.3).length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        case '4':
                            // 中高金額
                            amount = Math.floor(Math.random() * (5000 - 301 + 1)) + 301;
                            deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        case '5':
                            // 中高金額且來自高風險地區
                            amount = Math.floor(Math.random() * (5000 - 301 + 1)) + 301;
                            deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                            countryCode = ['004', '116', '408'][Math.floor(Math.random() * 3)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        case '6':
                            // 設備高風險
                            amount = Math.floor(Math.random() * (5000 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels.filter(r => r < -0.3)[Math.floor(Math.random() * deviceRiskLevels.filter(r => r < -0.3).length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        case '7':
                            // 15分鐘內來自不同地區
                            amount = Math.floor(Math.random() * (5000 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                            const prevTxFor7 = prevTxs.find(t => t.card === card);
                            countryCode = prevTxFor7 ? countryCodes.filter(c => c !== prevTxFor7.countryCode)[Math.floor(Math.random() * (countryCodes.length - 1))] : countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                        default:
                            // 未命中任何規則
                            amount = Math.floor(Math.random() * (5000 - 10 + 1)) + 10;
                            deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                            countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                            isVerified = Math.random() < 0.75;
                            cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);
                            break;
                    }

                    return { amount, countryCode, deviceRisk, isVerified, cumulativeAmount };
                }

                // 簡化生成交易 - 只生成基本數據和新欄位
                for (let i = 0; i < count; i++) {
                    const card = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)] +
                        Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0');
                    const timestamp = Utils.getRandomTime();
                    const countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                    const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                    const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;

                    const tx = {
                        id: i + 1,
                        card,
                        countryCode,
                        amount,
                        deviceRisk: deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)],
                        timestamp,
                        // 新增欄位
                        mcc: this.generateMCC(),
                        fraudDeviceModel: Math.random(),
                        cardAbnormalModel: Math.random() * 2 - 1,
                        cardTestModel: Math.random() * 2 - 1,
                        vpn: Math.random() < 0.1,
                        tor: Math.random() < 0.05,
                        webdriver: Math.random() < 0.15,
                        verificationResult: Math.random() < 0.8 ? '成功' : '失敗'
                    };

                    this.transactions.push(tx);
                }

                // 移除複雜的規則特定生成邏輯，簡化處理

                // 確保台灣交易
                const taiwanTxCount = this.transactions.filter(tx => tx.countryCode === '158').length;
                if (taiwanTxCount < 5) {
                    for (let i = 0; i < 5 - taiwanTxCount; i++) {
                        const card = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)] +
                            Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0');
                        const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                        const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;

                        this.transactions.push({
                            id: this.transactions.length + 1,
                            card,
                            countryCode: '158',
                            amount,
                            deviceRisk: deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)],
                            timestamp: Utils.getRandomTime(),
                            // 新增欄位
                            mcc: this.generateMCC(),
                            fraudDeviceModel: Math.random(),
                            cardAbnormalModel: Math.random() * 2 - 1,
                            cardTestModel: Math.random() * 2 - 1,
                            vpn: Math.random() < 0.1,
                            tor: Math.random() < 0.05,
                            webdriver: Math.random() < 0.15,
                            verificationResult: Math.random() < 0.8 ? '成功' : '失敗'
                        });
                    }
                }

                // 按時間排序交易
                this.transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                return this.transactions;
            },

            loadTransactions() {
                this.transactions.sort((a, b) => {
                    return new Date(a.timestamp) - new Date(b.timestamp);
                });
                const table = document.getElementById('transaction-table');
                table.innerHTML = '';

                this.transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', tx.id);
                    const displayCard = tx.card.length === 16
                        ? tx.card.substring(0, 8) + '********'
                        : '****************';

                    if (tx.card.length !== 16) {
                        Utils.addLog(`Invalid card length for transaction ${tx.id}: ${tx.card}`);
                    }

                    row.innerHTML = `
                        <td><i class="fas fa-circle-notch fa-spin text-secondary"></i></td>
                        <td class="font-monospace">${displayCard}</td>
                        <td>${Utils.formatDateTime(tx.timestamp)}</td>
                        <td>${Data.countryMap[tx.countryCode] || tx.countryCode}</td>
                        <td class="text-end">${tx.amount.toLocaleString()}</td>
                        <td>${tx.mcc || 'N/A'}</td>
                        <td class="text-end">
                            <span class="risk-badge ${
                                tx.fraudDeviceModel > 0.5 ? 'success' : tx.fraudDeviceModel >= 0.25 ? 'warning' : 'danger'
                            }">${tx.fraudDeviceModel ? tx.fraudDeviceModel.toFixed(2) : 'N/A'}</span>
                        </td>
                        <td class="text-end">
                            <span class="risk-badge ${
                                tx.cardAbnormalModel > 0 ? 'warning' : 'success'
                            }">${tx.cardAbnormalModel ? tx.cardAbnormalModel.toFixed(2) : 'N/A'}</span>
                        </td>
                        <td class="text-end">
                            <span class="risk-badge ${
                                tx.cardTestModel > 0 ? 'warning' : 'success'
                            }">${tx.cardTestModel ? tx.cardTestModel.toFixed(2) : 'N/A'}</span>
                        </td>
                        <td><span class="badge ${tx.vpn ? 'bg-warning' : 'bg-secondary'}">${tx.vpn ? 'VPN' : '無'}</span></td>
                        <td><span class="badge ${tx.tor ? 'bg-danger' : 'bg-secondary'}">${tx.tor ? 'Tor' : '無'}</span></td>
                        <td><span class="badge ${tx.webdriver ? 'bg-warning' : 'bg-secondary'}">${tx.webdriver ? 'Web' : '無'}</span></td>
                        <td></td>
                    `;

                    table.appendChild(row);
                });
            }
        };

        // 規則管理模塊
        const RuleManager = {
            elements: {
                executionZone: null,
                availableRules: null,
                placeholder: null,
                dropIndicator: null,
                defaultBtn: null,
                customBtn: null,
                transactionTable: null,
                logPanel: null
            },

            async init() {
                this.elements = {
                    executionZone: document.getElementById('execution-zone'),
                    availableRules: document.getElementById('available-rules'),
                    placeholder: document.getElementById('zone-placeholder'),
                    dropIndicator: document.getElementById('drop-indicator'),
                    defaultBtn: document.getElementById('default-btn'),
                    customBtn: document.getElementById('custom-btn'),
                    transactionTable: document.getElementById('transaction-table'),
                    logPanel: document.getElementById('log-panel')
                };

                this.initializeRules();
                TransactionManager.loadTransactions();
                await ChartManager.init();
                
                // 初始化後等待一下再更新圖表，確保地圖已加載
                setTimeout(() => {
                    ChartManager.updateAll();
                }, 500);

                const rulesTitle = document.getElementById('rules-title');
                if (rulesTitle) {
                    rulesTitle.addEventListener('click', () => this.handleTitleClick());
                }
            },

            initializeRules() {
                this.elements.availableRules.innerHTML = '';
                Data.rules.forEach(rule => this.addRuleToAvailable(rule));
            },

            handleTitleClick: function(event) {
                // 防止事件冒泡
                if (event) {
                    event.stopPropagation();
                }

                // 使用防抖動，確保短時間內多次調用只執行一次
                if (this.titleClickTimer) {
                    clearTimeout(this.titleClickTimer);
                }

                this.titleClickTimer = setTimeout(() => {
                    // 使用變數存儲點擊次數
                    if (!window.titleClickCount) {
                        window.titleClickCount = 0;
                    }
                    window.titleClickCount++;

                    console.log('標題被點擊了', window.titleClickCount, '次');

                    if (window.titleClickCount >= 4) {
                        const buttonGroup = document.querySelector('.btn-group.w-100.mb-3');
                        if (buttonGroup) {
                            buttonGroup.style.display = 'flex';
                            console.log('按鈕群組已顯示');
                            Utils.addLog('決策按鈕已顯示');

                             // 在這裡添加應用預設規則的代碼
                            this.applyDefaultRules();
                            console.log('已應用預設規則');
                            Utils.addLog('已應用預設規則');
                                    }
                    }
                }, 100); // 100毫秒內的多次點擊只算一次
            },


            addRuleToAvailable(rule) {
                if (document.querySelector(`#available-rules [data-id="${rule.id}"]`)) return;

                const ruleElement = document.createElement('div');
                ruleElement.className = `rule-item ${rule.level}`;
                ruleElement.draggable = true;
                ruleElement.setAttribute('data-id', rule.id);
                ruleElement.setAttribute('data-level', rule.level);
                ruleElement.setAttribute('data-description', rule.description);
                ruleElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rule-number">${rule.id}</div>
                        <div class="rule-icon ${rule.level}">
                            <i class="fas fa-${
                                rule.level === 'success' ? 'check' :
                                rule.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'
                            }"></i>
                        </div>
                        <span>${rule.text}</span>
                    </div>
                    <div class="rule-actions">
                        <i class="fas fa-arrows-alt handle"></i>
                    </div>
                `;
                ruleElement.addEventListener('dragstart', this.dragStart);
                ruleElement.addEventListener('mouseenter', () => this.showDescription(ruleElement));

                this.elements.availableRules.appendChild(ruleElement);
            },

            createRuleClone(rule) {
                const ruleId = rule instanceof Element ? rule.getAttribute('data-id') : rule.id;
                const ruleData = rule instanceof Element
                    ? {
                        id: ruleId,
                        level: rule.getAttribute('data-level'),
                        description: rule.getAttribute('data-description'),
                        text: rule.querySelector('.d-flex span').textContent
                    }
                    : rule;

                const clone = document.createElement('div');
                clone.className = `rule-item ${ruleData.level}`;
                clone.draggable = true;
                clone.setAttribute('data-id', ruleData.id);
                clone.setAttribute('data-level', ruleData.level);
                clone.setAttribute('data-description', ruleData.description);
                clone.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rule-number">${ruleData.id}</div>
                        <div class="rule-icon ${ruleData.level}">
                            <i class="fas fa-${
                                ruleData.level === 'success' ? 'check' :
                                ruleData.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'
                            }"></i>
                        </div>
                        <span>${ruleData.text}</span>
                    </div>
                    <div class="rule-actions">
                        <i class="fas fa-arrows-alt handle"></i>
                        <button class="btn-action" onclick="RuleManager.removeRule(this.parentNode.parentNode)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                clone.addEventListener('dragstart', this.dragStart);
                clone.addEventListener('mouseenter', () => this.showDescription(clone));

                return clone;
            },

            dragStart(event) {
                event.dataTransfer.setData('text/plain', event.target.getAttribute('data-id'));
                event.target.style.opacity = '0.4';

                // 當拖曳結束時自動恢復透明度
                const resetOpacity = () => {
                    event.target.style.opacity = '';
                    event.target.removeEventListener('dragend', resetOpacity);
                    event.target.removeEventListener('drop', resetOpacity);
                };
                event.target.addEventListener('dragend', resetOpacity);
                event.target.addEventListener('drop', resetOpacity);
            },

            allowDrop(event) {
                event.preventDefault();
                this.showDropIndicator(event);
            },

            showDropIndicator(event) {
                const items = Array.from(this.elements.executionZone.children).filter(child => child.classList.contains('rule-item'));
                this.elements.dropIndicator.classList.add('active');

                if (!items.length) {
                    this.elements.executionZone.insertBefore(this.elements.dropIndicator, this.elements.placeholder);
                    return;
                }

                let closestItem = null;
                let closestDistance = Number.MAX_VALUE;
                let position = 'before';

                items.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const middle = rect.top + rect.height / 2;
                    const distance = Math.abs(event.clientY - middle);

                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestItem = item;
                        position = event.clientY < middle ? 'before' : 'after';
                    }
                });

                this.elements.executionZone.insertBefore(
                    this.elements.dropIndicator,
                    position === 'before' ? closestItem : closestItem.nextSibling || this.elements.placeholder
                );
            },

            drop(event) {
                event.preventDefault();
                this.elements.dropIndicator.classList.remove('active');

                const ruleId = event.dataTransfer.getData('text/plain');
                const sourceRule = document.querySelector(`[data-id="${ruleId}"]`);
                if (!sourceRule) return;

                sourceRule.style.opacity = '';
                const isFromAvailable = sourceRule.parentNode.id === 'available-rules';

                if (isFromAvailable) {
                    const rule = Data.rules.find(r => r.id === ruleId);
                    if (!rule) return;
                    const newRule = this.createRuleClone(rule);
                    this.elements.executionZone.insertBefore(newRule, this.elements.dropIndicator.nextSibling || this.elements.placeholder);
                    sourceRule.remove();
                } else {
                    this.elements.executionZone.insertBefore(sourceRule, this.elements.dropIndicator.nextSibling || this.elements.placeholder);
                }

                this.updatePlaceholder();
                this.updateButtonState();
            },

            removeRule(rule) {
                const ruleId = rule.getAttribute('data-id');
                const originalRule = Data.rules.find(r => r.id === ruleId);
                if (originalRule) {
                    // 依照 Data.rules 的順序插入回 availableRules
                    const availableRules = this.elements.availableRules;
                    const allRuleIds = Data.rules.map(r => r.id);
                    const insertIndex = allRuleIds.indexOf(ruleId);

                    // 找到應插入的位置
                    let inserted = false;
                    for (let i = 0; i < availableRules.children.length; i++) {
                        const childId = availableRules.children[i].getAttribute('data-id');
                        if (childId && allRuleIds.indexOf(childId) > insertIndex) {
                            availableRules.insertBefore(this.createRuleClone(originalRule), availableRules.children[i]);
                            inserted = true;
                            break;
                        }
                    }
                    if (!inserted) {
                        availableRules.appendChild(this.createRuleClone(originalRule));
                    }
                    rule.remove();
                    this.updatePlaceholder();
                    this.updateButtonState();
                }
            },

            showDescription(element) {
                document.getElementById('rule-description').textContent = element.getAttribute('data-description');
            },

            updatePlaceholder() {
                this.elements.placeholder.style.display = this.elements.executionZone.querySelectorAll('.rule-item').length ? 'none' : 'block';
            },

            updateButtonState() {
                const currentRules = Array.from(this.elements.executionZone.querySelectorAll('.rule-item')).map(r => r.getAttribute('data-id'));
                const isDefault = currentRules.length === Data.defaultRuleIds.length &&
                    currentRules.every((id, i) => id === Data.defaultRuleIds[i]);

                this.elements.defaultBtn.classList.toggle('active', isDefault);
                this.elements.customBtn.classList.toggle('active', !isDefault);
            },

            applyDefaultRules() {
                this.clearRules();
                Data.defaultRuleIds.forEach(id => {
                    const rule = Data.rules.find(r => r.id === id);
                    if (rule) {
                        const newRule = this.createRuleClone(rule);
                        this.elements.executionZone.insertBefore(newRule, this.elements.placeholder);
                        const availableRule = document.querySelector(`#available-rules [data-id="${id}"]`);
                        if (availableRule) availableRule.remove();
                    }
                });
                this.updatePlaceholder();
                this.updateButtonState();
            },

            clearRules() {
                this.elements.executionZone.querySelectorAll('.rule-item').forEach(rule => {
                    const ruleId = rule.getAttribute('data-id');
                    const originalRule = Data.rules.find(r => r.id === ruleId);
                    if (originalRule) this.addRuleToAvailable(originalRule);
                    rule.remove();
                });
                this.updatePlaceholder();
                this.resetTransactionStatus();
            },

            resetTransactionStatus() {
                this.elements.transactionTable.querySelectorAll('tr').forEach(row => {
                    row.querySelector('td:first-child').innerHTML = '<i class="fas fa-circle-notch fa-spin text-secondary"></i>';
                    row.querySelector('td:nth-child(13)').textContent = '';
                    row.classList.remove('highlighted');
                });
            },

            executeRules() {
                Utils.clearLog();
                clearDebugLog(); // 清除調試日誌
                this.resetTransactionStatus();

                debugLog('開始執行規則引擎...', 'info');

                const activeRules = Array.from(this.elements.executionZone.querySelectorAll('.rule-item'))
                    .map(r => Data.rules.find(rule => rule.id === r.getAttribute('data-id')))
                    .filter(r => r);
                const riskLevel = document.getElementById('risk-level').value;

                // 在這裡添加載入效果 - 只覆蓋視覺效果，不替換整個內容
                const transactionPanel = document.querySelector('#transaction-table').closest('.card');
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
                loadingOverlay.innerHTML = `
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">正在處理交易...</p>
    `;

                transactionPanel.style.position = 'relative';
                transactionPanel.appendChild(loadingOverlay);

                Utils.addLog(`風險等級設置為: ${riskLevel}`);
                debugLog(`啟用規則: ${activeRules.map(r => `#${r.id}`).join(', ')}`, 'info');

                if (!activeRules.length) {
                    Utils.addLog(`沒有可用規則，所有交易設為${riskLevel}風險`);
                    TransactionManager.transactions.forEach(tx => this.processTransaction(tx, [], riskLevel, TransactionManager.transactions));
                    ChartManager.updateAll();

                    // 移除載入效果
                    setTimeout(() => {
                        const overlay = document.getElementById('loading-overlay');
                        if (overlay) overlay.remove();
                    }, 500);
                    return;
                }

                // 按时间顺序处理交易
                const sortedTransactions = [...TransactionManager.transactions]
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                debugLog(`按時間順序處理 ${sortedTransactions.length} 筆交易`, 'info');

                // 创建一个处理状态追踪数组
                const processedTransactions = [];

                // 重置所有交易的動作狀態
                sortedTransactions.forEach(tx => {
                    delete tx.action;
                });

                debugLog('開始逐筆處理交易...', 'info');
                // 按時間順序處理交易
                sortedTransactions.forEach((tx, index) => {
                    debugLog(`\n處理第 ${index + 1} 筆交易 (ID: ${tx.id})`, 'info');

                    // 處理當前交易時，只傳入已處理完的交易
                    this.processTransaction(tx, activeRules, riskLevel, processedTransactions);

                    // 將已處理的交易加入清單
                    processedTransactions.push(tx);
                });

                debugLog('所有交易處理完成', 'success');
                ChartManager.updateAll();

                // 移除載入效果
                setTimeout(() => {
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) overlay.remove();
                }, 500);
            },

            processTransaction(tx, activeRules, riskLevel, allTransactions) {
                debugLog(`\n=== 處理交易 ID: ${tx.id} ===`, 'info');
                debugLog(`卡號: ${tx.card.substring(0,8)}****, 金額: ${tx.amount}, 時間: ${Utils.formatDateTime(tx.timestamp)}`, 'info');

                const row = document.querySelector(`#transaction-table tr[data-id="${tx.id}"]`);
                const statusCell = row.querySelector('td:first-child');
                const hitRuleCell = row.querySelector('td:nth-child(13)');
                let action = this.getDefaultAction(riskLevel);
                let matchedRule = null;

                debugLog(`預設動作: ${action} (基於風險等級: ${riskLevel})`, 'info');
                debugLog(`可參考的歷史交易數: ${allTransactions.length}`, 'info');

                for (const rule of activeRules) {
                    debugLog(`\n檢查規則 #${rule.id}: ${rule.text}`, 'info');
                    try {
                        const conditionMet = rule.condition.length > 1
                            ? rule.condition(tx, allTransactions)  // 傳入所有已處理交易
                            : rule.condition(tx);                   // 只傳入當前交易

                        debugLog(`規則 #${rule.id} 結果: ${conditionMet}`, conditionMet ? 'success' : 'warning');

                        if (conditionMet) {
                            matchedRule = rule;
                            action = rule.action;
                            hitRuleCell.innerHTML = `<span class="badge bg-light text-dark">#${rule.id}</span> ${rule.text}`;
                            debugLog(`🎯 交易命中規則 #${rule.id}! 動作: ${action}`, 'success');
                            Utils.addLog(`交易 ${tx.card.substring(0,8)}**** (${Data.countryMap[tx.countryCode] || tx.countryCode}) 命中規則 #${rule.id}: ${rule.text}`);
                            break;
                        }
                    } catch (error) {
                        debugLog(`規則 #${rule.id} 執行錯誤: ${error.message}`, 'error');
                        console.error(`規則 #${rule.id} 執行錯誤:`, error);
                    }
                }
                if (!matchedRule) {
                    hitRuleCell.textContent = '未命中任何規則';
                    Utils.addLog(`交易 ${tx.card} (${Data.countryMap[tx.countryCode] || tx.countryCode}) 未命中任何規則，採用${riskLevel}風險預設行為`);
                }

                tx.action = action;

                statusCell.innerHTML = `
                    <i class="fas fa-${
                        action === 'APPROVE' ? 'check-circle text-success' :
                        action === 'REVIEW' ? 'exclamation-triangle text-warning' :
                        action === 'BLOCK' ? 'exclamation-circle text-danger' : 'question-circle text-secondary'
                    }"></i>
                `;
                row.classList.add('highlighted');debugLog(`交易處理完成，最終動作: ${action}`, action === 'APPROVE' ? 'success' : action === 'REVIEW' ? 'warning' : 'error');

                    return { action, matchedRule };
            },

            getDefaultAction(riskLevel) {
                return {
                    low: 'APPROVE',
                    medium: 'REVIEW',
                    high: 'BLOCK'
                }[riskLevel] || 'REVIEW';
            }
        };

        // 圖表管理模塊
        const ChartManager = {
            charts: {
                worldMap: null,
                hourlyRisk: null,
                riskPie: null
            },

            async init() {
                await this.initWorldMap();
                this.initHourlyRiskChart();
                this.initRiskPieChart();
                window.addEventListener('resize', () => {
                    Object.values(this.charts).forEach(chart => chart?.resize());
                });
            },

            async initWorldMap() {
                const chartDom = document.getElementById('world-map');
                if (!chartDom) return;

                this.charts.worldMap = echarts.init(chartDom);
                this.charts.worldMap.showLoading({ text: '加載世界地圖數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });

                // 嘗試多個路徑加載地圖數據
                const mapPaths = ['./wMap.json', 'wMap.json'];
                let mapLoaded = false;
                
                for (let i = 0; i < mapPaths.length && !mapLoaded; i++) {
                    try {
                        const response = await fetch(mapPaths[i]);
                        if (response.ok) {
                            const worldJson = await response.json();
                            echarts.registerMap('world', worldJson);
                            this.charts.worldMap.hideLoading();
                            
                            // 設置初始地圖配置
                            this.charts.worldMap.setOption({
                                backgroundColor: '#fff',
                                title: { 
                                    text: '交易高風險地區分佈', 
                                    subtext: '顏色深淺代表高風險交易數量', 
                                    left: 'center', 
                                    top: 10 
                                },
                                tooltip: {
                                    trigger: 'item',
                                    formatter: params => params.data
                                        ? `${params.data.name}<br/>
                                           總交易數量: ${params.data.totalCount || 0} 筆<br/>
                                           高風險交易: ${params.data.highRiskCount || 0} 筆<br/>
                                           高風險比例: ${params.data.highRiskPercentage || 0}%`
                                        : params.name
                                },
                                visualMap: {
                                    show: true,
                                    min: 0,
                                    max: 10,
                                    calculable: true,
                                    inRange: { color: ['#fee2e2', '#ef4444'] },
                                    text: ['高風險交易多', '高風險交易少'],
                                    left: 'left',
                                    top: 'bottom',
                                    textStyle: { color: '#333' }
                                },
                                series: [{
                                    name: '高風險交易',
                                    type: 'map',
                                    map: 'world',
                                    aspectScale: 0.75,
                                    roam: true,
                                    zoom: 1.2,
                                    center: [0, 30],
                                    selectedMode: false,
                                    label: { show: false },
                                    emphasis: { 
                                        label: { show: true, fontSize: 10, color: '#333' }, 
                                        itemStyle: { areaColor: '#fecaca' } 
                                    },
                                    data: [],
                                    itemStyle: { 
                                        areaColor: '#f5f5f5', 
                                        borderColor: '#ccc', 
                                        borderWidth: 0.5 
                                    }
                                }]
                            });
                            
                            mapLoaded = true;
                            Utils.addLog('世界地圖數據加載成功');
                        }
                    } catch (error) {
                        console.log(`路徑 ${mapPaths[i]} 失敗:`, error);
                    }
                }
                
                // 如果所有路徑都失敗，顯示錯誤信息
                if (!mapLoaded) {
                    this.charts.worldMap.hideLoading();
                    this.charts.worldMap.setOption({
                        backgroundColor: '#fff',
                        title: {
                            text: '地圖數據加載失敗',
                            subtext: '請確保從HTTP服務器運行此應用程式',
                            left: 'center',
                            top: 'center',
                            textStyle: { color: '#f44336', fontSize: 16 },
                            subtextStyle: { color: '#666', fontSize: 12 }
                        }
                    });
                    Utils.addLog('地圖數據加載失敗 - 可能需要從HTTP服務器運行');
                }
            },

            initHourlyRiskChart() {
                const chartDom = document.getElementById('hourly-risk-chart');
                if (!chartDom) return;

                this.charts.hourlyRisk = echarts.init(chartDom);
                this.charts.hourlyRisk.showLoading({ text: '加載交易數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });
                this.updateHourlyRiskChart();
            },

            initRiskPieChart() {
                const chartDom = document.getElementById('risk-pie-chart');
                if (!chartDom) return;

                this.charts.riskPie = echarts.init(chartDom);
                this.charts.riskPie.showLoading({ text: '分析交易數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });
                this.updateRiskPieChart();
            },

            updateWorldMap() {
                const chart = this.charts.worldMap;
                if (!chart || !echarts.getMap('world')) {
                    Utils.addLog('地圖未初始化或數據未載入');
                    return;
                }

                chart.showLoading({ text: '更新地圖數據...', maskColor: 'rgba(255, 255, 255, 0.5)', textColor: '#1890ff' });

                try {
                    const countryCounts = new Map();
                    const highRiskCounts = new Map();
                    const highRiskRuleCounts = new Map();

                    document.querySelectorAll('#transaction-table tr').forEach(row => {
                        const txId = row.getAttribute('data-id');
                        const tx = TransactionManager.transactions.find(t => t.id == txId);
                        if (!tx) return;

                        const isHighRisk = row.querySelector('td:first-child i')?.classList.contains('text-danger');
                        const hitRule = row.querySelector('td:nth-child(13) span')?.textContent || '';
                        countryCounts.set(tx.countryCode, (countryCounts.get(tx.countryCode) || 0) + 1);
                        if (isHighRisk) {
                            highRiskCounts.set(tx.countryCode, (highRiskCounts.get(tx.countryCode) || 0) + 1);
                            if (hitRule.includes('#7') || hitRule.includes('#8')) {
                                highRiskRuleCounts.set(tx.countryCode, (highRiskRuleCounts.get(tx.countryCode) || 0) + 1);
                            }
                        }
                    });

                    // 記錄高風險交易
                    const highRiskLog = Array.from(highRiskCounts.entries())
                        .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                        .join(', ');


                    const mapData = Array.from(countryCounts.entries()).map(([code, total]) => ({
                        name: Data.countryEChartsMap[code] || Data.countryMap[code] || code,
                        value: highRiskCounts.get(code) || 0,
                        totalCount: total,
                        highRiskCount: highRiskCounts.get(code) || 0,
                        highRiskRuleCount: highRiskRuleCounts.get(code) || 0,
                        highRiskPercentage: total ? Math.round(((highRiskCounts.get(code) || 0) / total) * 100) : 0,
                        originalCode: code
                    }));

                    chart.setOption({
                        backgroundColor: '#fff',
                        title: { text: '交易高風險地區分佈', subtext: '顏色深淺代表高風險交易數量', left: 'center', top: 10 },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => params.data
                                ? `${Data.countryMap[params.data.originalCode] || params.data.originalCode}<br/>
                                   總交易數量: ${params.data.totalCount} 筆<br/>
                                   高風險交易: ${params.data.highRiskCount} 筆<br/>
                                   高風險比例: ${params.data.highRiskPercentage}%`
                                : params.name
                        },
                        visualMap: {
                            show: true,
                            min: 0,
                            max: Math.max(...Array.from(highRiskCounts.values()), 1) * 1.5, // 進一步平滑顏色分佈
                            calculable: true,
                            inRange: { color: ['#fee2e2', '#ef4444'] },
                            text: ['高風險交易多', '高風險交易少'],
                            left: 'left',
                            top: 'bottom',
                            textStyle: { color: '#333' }
                        },
                        series: [{
                            name: '高風險交易',
                            type: 'map',
                            map: 'world',
                            aspectScale: 0.75,
                            roam: true,
                            zoom: 1.2,
                            selectedMode: false,
                            label: { show: false },
                            emphasis: { label: { show: true, fontSize: 10, color: '#333' }, itemStyle: { areaColor: '#fecaca' } },
                            data: mapData,
                            itemStyle: { areaColor: '#f5f5f5', borderColor: '#ccc', borderWidth: 0.5 }
                        }]
                    });

                    chart.hideLoading();
                    Utils.addLog(`地圖更新完成: 顯示 ${mapData.length} 個地區的高風險交易資料`);
                } catch (error) {
                    chart.hideLoading();
                    Utils.addLog(`地圖更新失敗: ${error.message}`);
                }
            },

            updateHourlyRiskChart() {
                const chart = this.charts.hourlyRisk;
                if (!chart) return;

                const hourlyData = Array.from({ length: 24 }, () => ({ low: 0, medium: 0, high: 0, total: 0 }));
                document.querySelectorAll('#transaction-table tr').forEach(row => {
                    const txId = row.getAttribute('data-id');
                    const tx = TransactionManager.transactions.find(t => t.id == txId);
                    if (!tx) return;

                    const hour = new Date(tx.timestamp).getHours();
                    const statusIcon = row.querySelector('td:first-child i');
                    const riskLevel = statusIcon?.classList.contains('text-success') ? 'low' :
                                     statusIcon?.classList.contains('text-warning') ? 'medium' :
                                     statusIcon?.classList.contains('text-danger') ? 'high' : 'medium';

                    hourlyData[hour][riskLevel]++;
                    hourlyData[hour].total++;
                });

                chart.setOption({
                    title: { text: '各時段交易風險分佈', subtext: '按小時統計的不同風險等級交易數量', left: 'center', top: 10 },
                    legend: { data: ['低風險', '中風險', '高風險'], left: '10%', bottom: 10 },
                    toolbox: { feature: { saveAsImage: {}, dataView: {} } },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: params => {
                            let total = 0;
                            let result = `${params[0].axisValueLabel}<br>`;
                            params.forEach(p => { total += p.value; result += `${p.marker} ${p.seriesName}: ${p.value}<br>`; });
                            return result + `<b>總計: ${total}</b>`;
                        }
                    },
                    xAxis: { data: Array.from({ length: 24 }, (_, i) => `${i}:00`), name: '小時', axisLine: { onZero: true }, splitLine: { show: false } },
                    yAxis: { name: '交易數量' },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                    series: [
                        { name: '低風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.low), itemStyle: { color: '#4CAF50' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } },
                        { name: '中風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.medium), itemStyle: { color: '#FFB300' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } },
                        { name: '高風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.high), itemStyle: { color: '#E57373' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } }
                    ]
                });

                chart.hideLoading();
                Utils.addLog('已更新風險時間分佈圖表');
            },

            updateRiskPieChart() {
                const chart = this.charts.riskPie;
                if (!chart) return;

                const riskData = { high: 0, medium: 0, low: 0, total: 0 };
                document.querySelectorAll('#transaction-table tr').forEach(row => {
                    const txId = row.getAttribute('data-id');
                    if (!txId) return;
                    const statusIcon = row.querySelector('td:first-child i');
                    if (!statusIcon) return;
                    if (statusIcon.classList.contains('text-success')) riskData.low++;
                    else if (statusIcon.classList.contains('text-warning')) riskData.medium++;
                    else if (statusIcon.classList.contains('text-danger')) riskData.high++;
                    riskData.total++;
                });

                Utils.addLog(`風險分布分析: 高風險 ${riskData.high} 筆, 中風險 ${riskData.medium} 筆, 低風險 ${riskData.low} 筆, 總計 ${riskData.total} 筆`);

                chart.setOption({
                    title: { text: '交易風險分佈', subtext: `總計 ${riskData.total} 筆交易`, left: 'center' },
                    tooltip: { trigger: 'item', formatter: '{a} <br>{b}: {c} 筆 ({d}%)' },
                    legend: { orient: 'vertical', left: 'left', data: ['高風險', '中風險', '低風險'] },
                    series: [{
                        name: '風險等級',
                        type: 'pie',
                        radius: '50%',
                        data: [
                            { value: riskData.high, name: '高風險' },
                            { value: riskData.medium, name: '中風險' },
                            { value: riskData.low, name: '低風險' }
                        ],
                        itemStyle: {
                            color: params => ['#E57373', '#FFB300', '#4CAF50'][params.dataIndex]
                        },
                        emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } },
                        label: { show: true, formatter: '{b}: {c} 筆 ({d}%)' }
                    }]
                });

                chart.hideLoading();
                Utils.addLog('已更新風險分佈圓餅圖');
            },

            updateAll() {
                setTimeout(() => {
                    this.updateWorldMap();
                    this.updateHourlyRiskChart();
                    this.updateRiskPieChart();
                }, 500);
            }
        };

        document.getElementById('scroll-button').addEventListener('click', function() {
            // 獲取目標元素
            const targetElement = document.getElementById('hourly-risk-chart');

            // 平滑滾動到目標元素
            targetElement.scrollIntoView({
                behavior: 'smooth'
            });
        });

        // 初始化應用
        window.onload = async () => {
            await TransactionManager.loadOrGenerateTransactions();
            await RuleManager.init();
        };
    </script>
</body>
</html>