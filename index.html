<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風險規則引擎沙盒</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body class="bkgd">
    <div class="container-fluid">
        <div class="title-area">
            <h2>風險規則引擎沙盒</h2>
            <p class="text-muted">拖放規則到執行區域以建立風險策略，可調整規則順序，點擊執行按鈕以應用規則</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <!-- Available rules -->
                    <div class="col-md-6">
                        <div class="card available-rules-card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">可用規則</h5>
                                <div class="mb-3">
                                    <div class="btn-group w-100 mb-3">
                                        <button id="default-btn" class="btn btn-outline-primary active" onclick="RuleManager.applyDefaultRules()">預設決策</button>
                                        <button id="custom-btn" class="btn btn-outline-primary" onclick="RuleManager.clearRules()">自訂決策</button>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="risk-level" class="form-label">未命中規則默認風險：</label>
                                        <select class="form-select" id="risk-level">
                                            <option value="low">低風險</option>
                                            <option value="medium" selected>中風險</option>
                                            <option value="high">高風險</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="available-rules" class="rules-panel"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Policy selection -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">決策配置</h5>
                                <div id="execution-zone" class="drop-zone rules-panel" ondragover="RuleManager.allowDrop(event)" ondrop="RuleManager.drop(event)">
                                    <div class="drop-zone-placeholder" id="zone-placeholder">
                                        <div>拖放規則到此處</div>
                                        <small>從左側拖曳規則到此區域</small>
                                    </div>
                                    <div class="drop-indicator" id="drop-indicator"></div>
                                </div>
                                <button class="btn btn-dark w-100" onclick="RuleManager.executeRules()">
                                    <i class="fas fa-play me-2"></i>執行規則
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description area -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">規則描述</h5>
                                <div class="description-area" id="description-area">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle me-2 text-primary mt-1"></i>
                                        <p class="mb-0" id="rule-description">將游標懸停在規則上可查看詳細描述。規則順序決定風險評估優先級。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log panel -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">執行日誌</h5>
                                <div id="log-panel" class="log-panel"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transaction Table -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title">交易監控</h5>
                            <div class="text-muted small">風險規則將套用於此表格中的交易</div>
                        </div>
                        <div class="table-responsive fixed-width-container">
                            <table class="table transaction-table">
                                <thead>
                                    <tr>
                                        <th>狀態</th>
                                        <th>卡號</th>
                                        <th>時間</th>
                                        <th>國家</th>
                                        <th class="text-end">金額</th>
                                        <th class="text-end">設備風險</th>
                                        <th>命中規則</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">交易地區分佈</h5>
                        <div class="text-muted small">各國家/地區交易數量</div>
                    </div>
                    <div id="world-map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">交易風險時間分佈</h5>
                        <div class="text-muted small">各時段風險交易數量統計</div>
                    </div>
                    <div id="hourly-risk-chart" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">交易風險分佈</h5>
                        <div class="text-muted small">各風險等級交易數量統計</div>
                    </div>
                    <div id="risk-pie-chart" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 工具函數模塊
        const Utils = {
            getRandomTime(minHoursAgo = 0, maxHoursAgo = 48) {
                const now = new Date();
                const hoursAgo = Math.random() * (maxHoursAgo - minHoursAgo) + minHoursAgo;
                return new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);
            },

            formatDateTime(date) {
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            },

            isWithin24Hours(timestamp) {
                const now = new Date();
                const txTime = new Date(timestamp);
                return (now - txTime) / (1000 * 60 * 60) <= 24;
            },

            hasMultipleCountriesIn15Min(tx, transactions) {
                const txTime = new Date(tx.timestamp);
                const countries = new Set(
                    transactions
                        .filter(t => t.card === tx.card)
                        .filter(t => Math.abs((txTime - new Date(t.timestamp)) / (1000 * 60)) <= 15)
                        .map(t => t.countryCode)
                );
                return countries.size > 1;
            },

            addLog(message) {
                const logPanel = document.getElementById('log-panel');
                if (!logPanel) {
                    console.warn('Log panel not initialized:', message);
                    return;
                }
                const logEntry = document.createElement('div');
                logEntry.textContent = `> ${message}`;
                logPanel.appendChild(logEntry);
                logPanel.scrollTop = logPanel.scrollHeight;
            },

            clearLog() {
                const logPanel = document.getElementById('log-panel');
                if (logPanel) logPanel.innerHTML = '';
            },

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        };

        // 數據定義
        const Data = {
            countryMap: {
                '344': '中國', '408': '朝鮮', '702': '新加坡', '840': '美國', '156': '中國', '392': '日本',
                '124': '加拿大', '276': '德國', '826': '英國', '036': '澳洲', '250': '法國', '356': '印度',
                '360': '印尼', '410': '南韓', '458': '馬來西亞', '484': '墨西哥', '643': '俄羅斯', '764': '泰國',
                '704': '越南', '158': '臺灣', '496': '蒙古', '608': '菲律賓', '418': '寮國', '104': '緬甸',
                '116': '柬埔寨', '096': '汶萊', '398': '哈薩克', '795': '土庫曼', '860': '烏茲別克',
                '762': '塔吉克', '417': '吉爾吉斯', '051': '亞美尼亞', '031': '亞塞拜然', '268': '喬治亞',
                '368': '伊拉克', '364': '伊朗', '682': '沙烏地阿拉伯', '784': '阿拉伯聯合大公國', '634': '卡達',
                '414': '科威特', '512': '阿曼', '887': '葉門', '760': '敘利亞', '422': '黎巴嫩', '400': '約旦',
                '376': '以色列', '586': '巴基斯坦', '004': '阿富汗', '050': '孟加拉', '144': '斯里蘭卡',
                '524': '尼泊爾', '064': '不丹', '462': '馬爾地夫', '203': '捷克', '348': '匈牙利', '616': '波蘭',
                '040': '奧地利', '380': '義大利', '756': '瑞士', '724': '西班牙', '620': '葡萄牙', '056': '比利時',
                '528': '荷蘭', '578': '挪威', '752': '瑞典', '246': '芬蘭', '208': '丹麥', '372': '愛爾蘭',
                '300': '希臘', '642': '羅馬尼亞', '100': '保加利亞', '688': '塞爾維亞', '191': '克羅埃西亞',
                '705': '斯洛維尼亞', '703': '斯洛伐克', '440': '立陶宛', '428': '拉脫維亞', '233': '愛沙尼亞',
                '498': '摩爾多瓦', '804': '烏克蘭', '112': '白俄羅斯', '710': '南非', '404': '肯亞',
                '231': '衣索比亞', '818': '埃及', '504': '摩洛哥', '788': '突尼西亞', '012': '阿爾及利亞',
                '288': '迦納', '566': '奈及利亞', '180': '剛果', '024': '安哥拉', '716': '辛巴威', '516': '納米比亞',
                '072': '波札那', '748': '史瓦濟蘭', '508': '莫三比克', '894': '尚比亞', '834': '坦尚尼亞',
                '800': '烏干達', '450': '馬達加斯加', '480': '模里西斯', '175': '馬約特', '638': '留尼旺',
                '732': '西撒哈拉', '466': '馬利', '562': '尼日', '148': '查德', '204': '貝南', '768': '多哥',
                '270': '甘比亞', '324': '幾內亞', '430': '賴比瑞亞', '384': '象牙海岸', '854': '布吉納法索',
                '729': '蘇丹', '728': '南蘇丹', '686': '塞內加爾', '478': '茅利塔尼亞', '831': '格瑞那達',
                '032': '阿根廷', '076': '巴西', '170': '哥倫比亞', '604': '秘魯', '152': '智利', '862': '委內瑞拉',
                '218': '厄瓜多', '068': '玻利維亞', '600': '巴拉圭', '858': '烏拉圭', '328': '蓋亞那',
                '740': '蘇利南', '238': '福克蘭群島', '320': '瓜地馬拉', '591': '巴拿馬', '188': '哥斯大黎加',
                '340': '宏都拉斯', '222': '薩爾瓦多', '558': '尼加拉瓜', '084': '貝里斯', '192': '古巴',
                '332': '海地', '214': '多明尼加', '388': '牙買加', '052': '巴巴多斯', '028': '安地卡及巴布達',
                '044': '巴哈馬', '780': '千里達', '010': '南極洲', '744': '亞速爾群島', '474': '馬提尼克',
                '312': '瓜德羅普', '660': '安圭拉', '254': '法屬圭亞那', '500': '蒙特塞拉特', '654': '聖赫勒拿',
                '090': '所羅門群島', '548': '萬那杜', '242': '斐濟', '316': '關島', '583': '密克羅尼西亞',
                '580': '北馬里亞納', '585': '帛琉', '016': '美屬薩摩亞', '882': '薩摩亞', '296': '吉里巴斯',
                '776': '東加', '570': '紐埃', '612': '皮特肯群島', '162': '聖誕島', '334': '赫德島和麥克唐納群島',
                '574': '諾福克島', '520': '瑙魯', '798': '吐瓦魯', '136': '開曼群島', '796': '特克斯和凱科斯群島',
                '092': '英屬維京群島', '772': '托克勞', '876': '瓦利斯和富圖納', '184': '庫克群島',
                '258': '法屬波利尼西亞', '540': '新喀里多尼亞'
            },

            countryEChartsMap: {
                '156': 'China', '344': 'China', '158': 'Taiwan', '392': 'Japan', '408': 'North Korea',
                '124': 'Canada', '840': 'United States of America', '276': 'Germany', '826': 'United Kingdom',
                '702': 'Singapore', '804': 'Ukraine', '036': 'Australia', '250': 'France', '356': 'India',
                '360': 'Indonesia', '410': 'South Korea', '458': 'Malaysia', '484': 'Mexico', '643': 'Russia',
                '764': 'Thailand', '704': 'Vietnam', '496': 'Mongolia', '608': 'Philippines', '418': 'Laos',
                '104': 'Myanmar', '116': 'Cambodia', '096': 'Brunei', '398': 'Kazakhstan', '795': 'Turkmenistan',
                '860': 'Uzbekistan', '762': 'Tajikistan', '417': 'Kyrgyzstan', '051': 'Armenia', '031': 'Azerbaijan',
                '268': 'Georgia', '368': 'Iraq', '364': 'Iran', '682': 'Saudi Arabia', '784': 'United Arab Emirates',
                '634': 'Qatar', '414': 'Kuwait', '512': 'Oman', '887': 'Yemen', '760': 'Syria', '422': 'Lebanon',
                '400': 'Jordan', '376': 'Israel', '586': 'Pakistan', '004': 'Afghanistan', '050': 'Bangladesh',
                '144': 'Sri Lanka', '524': 'Nepal', '203': 'Czech Republic', '348': 'Hungary', '616': 'Poland',
                '040': 'Austria', '380': 'Italy', '756': 'Switzerland', '724': 'Spain', '620': 'Portugal',
                '056': 'Belgium', '528': 'Netherlands', '578': 'Norway', '752': 'Sweden', '246': 'Finland',
                '208': 'Denmark', '372': 'Ireland', '300': 'Greece', '642': 'Romania', '100': 'Bulgaria',
                '191': 'Croatia', '705': 'Slovenia', '440': 'Lithuania', '428': 'Latvia', '233': 'Estonia',
                '112': 'Belarus', '710': 'South Africa', '404': 'Kenya', '231': 'Ethiopia', '818': 'Egypt',
                '504': 'Morocco', '788': 'Tunisia', '012': 'Algeria', '288': 'Ghana', '566': 'Nigeria',
                '032': 'Argentina', '076': 'Brazil', '170': 'Colombia', '604': 'Peru', '152': 'Chile',
                '862': 'Venezuela', '218': 'Ecuador', '068': 'Bolivia', '600': 'Paraguay', '858': 'Uruguay'
            },

            rules: [
                { id: '1', text: '小金額且設備低風險', level: 'success', description: '交易金額低於500元且來自已知安全設備，可自動通過',
                  condition: tx => tx.amount < 500 && tx.deviceRisk > 0.2, action: 'APPROVE' },
                { id: '2', text: '1天內驗證成功，累積金額小於$1000', level: 'success', description: '用戶在過去24小時內已經完成驗證，且累積交易金額低於1000元',
                  condition: tx => tx.isVerified && tx.cumulativeAmount < 1000 && Utils.isWithin24Hours(tx.timestamp), action: 'APPROVE' },
                { id: '3', text: '設備中風險', level: 'warning', description: '使用者的設備風險評分在0至0.5之間，建議額外監控',
                  condition: tx => tx.deviceRisk >= 0 && tx.deviceRisk <= 0.5, action: 'REVIEW' },
                { id: '4', text: '中高金額', level: 'warning', description: '單筆交易金額超過300元，需要額外審核',
                  condition: tx => tx.amount > 300, action: 'REVIEW' },
                { id: '5', text: '中高金額且來自高風險國家', level: 'danger', description: '交易金額超過500元且來源IP位於高風險國家',
                  condition: tx => tx.amount > 500 && ['408', '804'].includes(tx.countryCode), action: 'BLOCK' },
                { id: '6', text: '設備高風險', level: 'danger', description: '設備風險評分為負數，可能表示有異常活動',
                  condition: tx => tx.deviceRisk < 0, action: 'BLOCK' },
                { id: '7', text: '15分鐘內來自不同國家', level: 'danger', description: '同一卡號在15分鐘內從不同國家發起交易',
                  condition: tx => Utils.hasMultipleCountriesIn15Min(tx, TransactionManager.transactions), action: 'BLOCK' }
            ],

            defaultRuleIds: ['7', '5', '6', '4', '3']
        };

        // 交易管理模塊
        const TransactionManager = {
            transactions: [],

            generateTransactions(count = 200) {
                this.transactions = [];
                const countryCodes = Object.keys(Data.countryMap).concat('158');
                const deviceRiskLevels = [-0.9, -0.8, -0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
                const bankCardPrefixes = ['4', '5', '3', '6'];
                const amountRanges = [
                    { min: 10, max: 300 }, { min: 301, max: 800 },
                    { min: 801, max: 2000 }, { min: 2001, max: 10000 }
                ];

                // 生成跨國卡號
                const crossBorderCards = Array.from({ length: 20 }, () => {
                    const prefix = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)];
                    const randomDigits = Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0');
                    return prefix + randomDigits;
                });

                // 生成主要交易
                for (let i = 0; i < count; i++) {
                    const isCrossBorder = Math.random() < 0.15;
                    const card = isCrossBorder
                        ? crossBorderCards[Math.floor(Math.random() * crossBorderCards.length)]
                        : bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)] +
                          Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0');

                    const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                    const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;
                    const countryCode = Math.random() < 0.05 ? '158' : Utils.shuffleArray([...countryCodes])[Math.floor(Math.random() * countryCodes.length)];
                    const deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                    const isVerified = Math.random() < 0.75;
                    const cumulativeAmount = amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0);

                    this.transactions.push({
                        id: i + 1,
                        card,
                        countryCode,
                        amount,
                        deviceRisk,
                        isVerified,
                        cumulativeAmount,
                        timestamp: Utils.getRandomTime()
                    });
                }

                // 添加跨國交易
                for (const card of crossBorderCards) {
                    const cardTxs = this.transactions.filter(tx => tx.card === card);
                    if (cardTxs.length) {
                        const baseTx = cardTxs[0];
                        const newTime = new Date(new Date(baseTx.timestamp).getTime() + Math.random() * 55 * 60 * 1000);
                        const availableCountries = Utils.shuffleArray(countryCodes.filter(c => c !== baseTx.countryCode));
                        const newCountryCode = baseTx.countryCode !== '158' && Math.random() < 0.2
                            ? '158'
                            : availableCountries[Math.floor(Math.random() * availableCountries.length)] || countryCodes[Math.floor(Math.random() * countryCodes.length)];

                        this.transactions.push({
                            id: this.transactions.length + 1,
                            card,
                            countryCode: newCountryCode,
                            amount: Math.floor(Math.random() * 1000) + 100,
                            deviceRisk: baseTx.deviceRisk,
                            isVerified: baseTx.isVerified,
                            cumulativeAmount: baseTx.cumulativeAmount + Math.floor(Math.random() * 500),
                            timestamp: newTime
                        });
                    }
                }

                // 確保台灣交易
                const taiwanTxCount = this.transactions.filter(tx => tx.countryCode === '158').length;
                if (taiwanTxCount < 5) {
                    for (let i = 0; i < 5 - taiwanTxCount; i++) {
                        const card = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)] +
                            Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0');
                        const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                        const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;

                        this.transactions.push({
                            id: this.transactions.length + 1,
                            card,
                            countryCode: '158',
                            amount,
                            deviceRisk: deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)],
                            isVerified: Math.random() < 0.75,
                            cumulativeAmount: amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0),
                            timestamp: Utils.getRandomTime()
                        });
                    }
                }

                // 記錄國家分佈統計
                const countryStats = new Map();
                this.transactions.forEach(tx => {
                    countryStats.set(tx.countryCode, (countryStats.get(tx.countryCode) || 0) + 1);
                });
                Utils.addLog(`交易生成完成：共 ${this.transactions.length} 筆，涵蓋 ${countryStats.size} 個國家`);
                const topCountries = Array.from(countryStats.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                    .join(', ');
                Utils.addLog(`交易最多的前5個國家: ${topCountries}`);

                this.transactions.forEach(tx => {
                    if (tx.card.length !== 16) {
                        Utils.addLog(`Invalid card length for transaction ${tx.id}: ${tx.card}`);
                    }
                });

                return this.transactions;
            },

            loadTransactions() {
                const table = document.getElementById('transaction-table');
                table.innerHTML = '';

                this.transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', tx.id);
                    const displayCard = tx.card.length === 16
                        ? tx.card.substring(0, 8) + '********'
                        : '****************';

                    if (tx.card.length !== 16) {
                        Utils.addLog(`Invalid card length for transaction ${tx.id}: ${tx.card}`);
                    }

                    row.innerHTML = `
                        <td><i class="fas fa-circle-notch fa-spin text-secondary"></i></td>
                        <td class="font-monospace">${displayCard}</td>
                        <td>${Utils.formatDateTime(tx.timestamp)}</td>
                        <td>${Data.countryMap[tx.countryCode] || tx.countryCode}</td>
                        <td class="text-end">${tx.amount.toLocaleString()}</td>
                        <td class="text-end">
                            <span class="risk-badge ${
                                tx.deviceRisk > 0.3 ? 'success' : tx.deviceRisk >= 0 ? 'warning' : 'danger'
                            }">${tx.deviceRisk.toFixed(1)}</span>
                        </td>
                        <td></td>
                    `;

                    table.appendChild(row);
                });
            }
        };

        // 規則管理模塊
        const RuleManager = {
            elements: {
                executionZone: null,
                availableRules: null,
                placeholder: null,
                dropIndicator: null,
                defaultBtn: null,
                customBtn: null,
                transactionTable: null,
                logPanel: null
            },

            init() {
                this.elements = {
                    executionZone: document.getElementById('execution-zone'),
                    availableRules: document.getElementById('available-rules'),
                    placeholder: document.getElementById('zone-placeholder'),
                    dropIndicator: document.getElementById('drop-indicator'),
                    defaultBtn: document.getElementById('default-btn'),
                    customBtn: document.getElementById('custom-btn'),
                    transactionTable: document.getElementById('transaction-table'),
                    logPanel: document.getElementById('log-panel')
                };

                this.initializeRules();
                TransactionManager.loadTransactions();
                this.applyDefaultRules();
                ChartManager.init();
            },

            initializeRules() {
                this.elements.availableRules.innerHTML = '';
                Data.rules.forEach(rule => this.addRuleToAvailable(rule));
            },

            addRuleToAvailable(rule) {
                if (document.querySelector(`#available-rules [data-id="${rule.id}"]`)) return;

                const ruleElement = document.createElement('div');
                ruleElement.className = `rule-item ${rule.level}`;
                ruleElement.draggable = true;
                ruleElement.setAttribute('data-id', rule.id);
                ruleElement.setAttribute('data-level', rule.level);
                ruleElement.setAttribute('data-description', rule.description);
                ruleElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rule-number">${rule.id}</div>
                        <div class="rule-icon ${rule.level}">
                            <i class="fas fa-${
                                rule.level === 'success' ? 'check' :
                                rule.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'
                            }"></i>
                        </div>
                        <span>${rule.text}</span>
                    </div>
                    <div class="rule-actions">
                        <i class="fas fa-arrows-alt handle"></i>
                    </div>
                `;
                ruleElement.addEventListener('dragstart', this.dragStart);
                ruleElement.addEventListener('mouseenter', () => this.showDescription(ruleElement));

                this.elements.availableRules.appendChild(ruleElement);
            },

            createRuleClone(rule) {
                const ruleId = rule instanceof Element ? rule.getAttribute('data-id') : rule.id;
                const ruleData = rule instanceof Element
                    ? {
                        id: ruleId,
                        level: rule.getAttribute('data-level'),
                        description: rule.getAttribute('data-description'),
                        text: rule.querySelector('.d-flex span').textContent
                    }
                    : rule;

                const clone = document.createElement('div');
                clone.className = `rule-item ${ruleData.level}`;
                clone.draggable = true;
                clone.setAttribute('data-id', ruleData.id);
                clone.setAttribute('data-level', ruleData.level);
                clone.setAttribute('data-description', ruleData.description);
                clone.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="rule-number">${ruleData.id}</div>
                        <div class="rule-icon ${ruleData.level}">
                            <i class="fas fa-${
                                ruleData.level === 'success' ? 'check' :
                                ruleData.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'
                            }"></i>
                        </div>
                        <span>${ruleData.text}</span>
                    </div>
                    <div class="rule-actions">
                        <i class="fas fa-arrows-alt handle"></i>
                        <button class="btn-action" onclick="RuleManager.removeRule(this.parentNode.parentNode)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                clone.addEventListener('dragstart', this.dragStart);
                clone.addEventListener('mouseenter', () => this.showDescription(clone));

                return clone;
            },

            dragStart(event) {
                event.dataTransfer.setData('text/plain', event.target.getAttribute('data-id'));
                event.target.style.opacity = '0.4';
            },

            allowDrop(event) {
                event.preventDefault();
                this.showDropIndicator(event);
            },

            showDropIndicator(event) {
                const items = Array.from(this.elements.executionZone.children).filter(child => child.classList.contains('rule-item'));
                this.elements.dropIndicator.classList.add('active');

                if (!items.length) {
                    this.elements.executionZone.insertBefore(this.elements.dropIndicator, this.elements.placeholder);
                    return;
                }

                let closestItem = null;
                let closestDistance = Number.MAX_VALUE;
                let position = 'before';

                items.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const middle = rect.top + rect.height / 2;
                    const distance = Math.abs(event.clientY - middle);

                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestItem = item;
                        position = event.clientY < middle ? 'before' : 'after';
                    }
                });

                this.elements.executionZone.insertBefore(
                    this.elements.dropIndicator,
                    position === 'before' ? closestItem : closestItem.nextSibling || this.elements.placeholder
                );
            },

            drop(event) {
                event.preventDefault();
                this.elements.dropIndicator.classList.remove('active');

                const ruleId = event.dataTransfer.getData('text/plain');
                const sourceRule = document.querySelector(`[data-id="${ruleId}"]`);
                if (!sourceRule) return;

                sourceRule.style.opacity = '';
                const isFromAvailable = sourceRule.parentNode.id === 'available-rules';

                if (isFromAvailable) {
                    const rule = Data.rules.find(r => r.id === ruleId);
                    if (!rule) return;
                    const newRule = this.createRuleClone(rule);
                    this.elements.executionZone.insertBefore(newRule, this.elements.dropIndicator.nextSibling || this.elements.placeholder);
                    sourceRule.remove();
                } else {
                    this.elements.executionZone.insertBefore(sourceRule, this.elements.dropIndicator.nextSibling || this.elements.placeholder);
                }

                this.updatePlaceholder();
                this.updateButtonState();
            },

            removeRule(rule) {
                const ruleId = rule.getAttribute('data-id');
                const originalRule = Data.rules.find(r => r.id === ruleId);
                if (originalRule) {
                    this.addRuleToAvailable(originalRule);
                    rule.remove();
                    this.updatePlaceholder();
                    this.updateButtonState();
                }
            },

            showDescription(element) {
                document.getElementById('rule-description').textContent = element.getAttribute('data-description');
            },

            updatePlaceholder() {
                this.elements.placeholder.style.display = this.elements.executionZone.querySelectorAll('.rule-item').length ? 'none' : 'block';
            },

            updateButtonState() {
                const currentRules = Array.from(this.elements.executionZone.querySelectorAll('.rule-item')).map(r => r.getAttribute('data-id'));
                const isDefault = currentRules.length === Data.defaultRuleIds.length &&
                    currentRules.every((id, i) => id === Data.defaultRuleIds[i]);

                this.elements.defaultBtn.classList.toggle('active', isDefault);
                this.elements.customBtn.classList.toggle('active', !isDefault);
            },

            applyDefaultRules() {
                this.clearRules();
                Data.defaultRuleIds.forEach(id => {
                    const rule = Data.rules.find(r => r.id === id);
                    if (rule) {
                        const newRule = this.createRuleClone(rule);
                        this.elements.executionZone.insertBefore(newRule, this.elements.placeholder);
                        const availableRule = document.querySelector(`#available-rules [data-id="${id}"]`);
                        if (availableRule) availableRule.remove();
                    }
                });
                this.updatePlaceholder();
                this.updateButtonState();
            },

            clearRules() {
                this.elements.executionZone.querySelectorAll('.rule-item').forEach(rule => {
                    const ruleId = rule.getAttribute('data-id');
                    const originalRule = Data.rules.find(r => r.id === ruleId);
                    if (originalRule) this.addRuleToAvailable(originalRule);
                    rule.remove();
                });
                this.updatePlaceholder();
                this.resetTransactionStatus();
            },

            resetTransactionStatus() {
                this.elements.transactionTable.querySelectorAll('tr').forEach(row => {
                    row.querySelector('td:first-child').innerHTML = '<i class="fas fa-circle-notch fa-spin text-secondary"></i>';
                    row.querySelector('td:last-child').textContent = '';
                    row.classList.remove('highlighted');
                });
            },

            executeRules() {
                Utils.clearLog();
                this.resetTransactionStatus();

                const activeRules = Array.from(this.elements.executionZone.querySelectorAll('.rule-item'))
                    .map(r => Data.rules.find(rule => rule.id === r.getAttribute('data-id')))
                    .filter(r => r);
                const riskLevel = document.getElementById('risk-level').value;

                Utils.addLog(`風險等級設置為: ${riskLevel}`);

                if (!activeRules.length) {
                    Utils.addLog(`沒有可用規則，所有交易設為${riskLevel}風險`);
                    TransactionManager.transactions.forEach(tx => this.processTransaction(tx, [], riskLevel));
                    ChartManager.updateAll();
                    return;
                }

                const rule7Hits = new Map();
                TransactionManager.transactions.forEach(tx => {
                    const result = this.processTransaction(tx, activeRules, riskLevel);
                    if (result.matchedRule?.id === '7') {
                        rule7Hits.set(tx.countryCode, (rule7Hits.get(tx.countryCode) || 0) + 1);
                    }
                });

                // 記錄規則 #7 命中分佈
                const rule7Log = Array.from(rule7Hits.entries())
                    .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                    .join(', ');
                if (rule7Log) {
                    Utils.addLog(`規則 #7 命中分佈: ${rule7Log}`);
                }

                ChartManager.updateAll();
            },

            processTransaction(tx, activeRules, riskLevel) {
                const row = document.querySelector(`#transaction-table tr[data-id="${tx.id}"]`);
                const statusCell = row.querySelector('td:first-child');
                const hitRuleCell = row.querySelector('td:last-child');
                let action = this.getDefaultAction(riskLevel);
                let matchedRule = null;

                for (const rule of activeRules) {
                    if (rule.condition(tx)) {
                        matchedRule = rule;
                        action = rule.action;
                        hitRuleCell.innerHTML = `<span class="badge bg-light text-dark">#${rule.id}</span> ${rule.text}`;
                        Utils.addLog(`交易 ${tx.card} (${Data.countryMap[tx.countryCode] || tx.countryCode}) 命中規則 #${rule.id}: ${rule.text}`);
                        break;
                    }
                }

                if (!matchedRule) {
                    hitRuleCell.textContent = '未命中任何規則';
                    Utils.addLog(`交易 ${tx.card} (${Data.countryMap[tx.countryCode] || tx.countryCode}) 未命中任何規則，採用${riskLevel}風險預設行為`);
                }

                statusCell.innerHTML = `
                    <i class="fas fa-${
                        action === 'APPROVE' ? 'check-circle text-success' :
                        action === 'REVIEW' ? 'exclamation-triangle text-warning' :
                        action === 'BLOCK' ? 'exclamation-circle text-danger' : 'question-circle text-secondary'
                    }"></i>
                `;
                row.classList.add('highlighted');

                return { action, matchedRule };
            },

            getDefaultAction(riskLevel) {
                return {
                    low: 'APPROVE',
                    medium: 'REVIEW',
                    high: 'BLOCK'
                }[riskLevel] || 'REVIEW';
            }
        };

        // 圖表管理模塊
        const ChartManager = {
            charts: {
                worldMap: null,
                hourlyRisk: null,
                riskPie: null
            },

            init() {
                this.initWorldMap();
                this.initHourlyRiskChart();
                this.initRiskPieChart();
                window.addEventListener('resize', () => {
                    Object.values(this.charts).forEach(chart => chart?.resize());
                });
            },

            initWorldMap() {
                const chartDom = document.getElementById('world-map');
                if (!chartDom) return;

                this.charts.worldMap = echarts.init(chartDom);
                this.charts.worldMap.showLoading({ text: '加載世界地圖數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });

                fetch('./wMap.json')
                    .then(response => {
                        if (!response.ok) throw new Error(`無法獲取地圖數據: ${response.statusText}`);
                        return response.json();
                    })
                    .then(worldJson => {
                        echarts.registerMap('world', worldJson);
                        this.charts.worldMap.hideLoading();
                        this.charts.worldMap.setOption({ series: [{ center: [0, 30], zoom: 1.2 }] });
                        Utils.addLog('世界地圖數據加載成功');
                    })
                    .catch(error => Utils.addLog(`加載地圖數據失敗: ${error.message}`));
            },

            initHourlyRiskChart() {
                const chartDom = document.getElementById('hourly-risk-chart');
                if (!chartDom) return;

                this.charts.hourlyRisk = echarts.init(chartDom);
                this.charts.hourlyRisk.showLoading({ text: '加載交易數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });
                this.updateHourlyRiskChart();
            },

            initRiskPieChart() {
                const chartDom = document.getElementById('risk-pie-chart');
                if (!chartDom) return;

                this.charts.riskPie = echarts.init(chartDom);
                this.charts.riskPie.showLoading({ text: '分析交易數據中...', maskColor: 'rgba(255, 255, 255, 0.8)', textColor: '#1890ff' });
                this.updateRiskPieChart();
            },

            updateWorldMap() {
                const chart = this.charts.worldMap;
                if (!chart || !echarts.getMap('world')) {
                    Utils.addLog('地圖未初始化或數據未載入');
                    return;
                }

                chart.showLoading({ text: '更新地圖數據...', maskColor: 'rgba(255, 255, 255, 0.5)', textColor: '#1890ff' });

                try {
                    const countryCounts = new Map();
                    const highRiskCounts = new Map();
                    const rule7Counts = new Map();

                    document.querySelectorAll('#transaction-table tr').forEach(row => {
                        const txId = row.getAttribute('data-id');
                        const tx = TransactionManager.transactions.find(t => t.id == txId);
                        if (!tx) return;

                        const isHighRisk = row.querySelector('td:first-child i')?.classList.contains('text-danger');
                        const hitRule = row.querySelector('td:last-child span')?.textContent || '';
                        countryCounts.set(tx.countryCode, (countryCounts.get(tx.countryCode) || 0) + 1);
                        if (isHighRisk) {
                            highRiskCounts.set(tx.countryCode, (highRiskCounts.get(tx.countryCode) || 0) + 1);
                            if (hitRule.includes('#7')) {
                                rule7Counts.set(tx.countryCode, (rule7Counts.get(tx.countryCode) || 0) + 1);
                            }
                        }
                    });

                    // 記錄高風險交易和規則 #7 命中分佈
                    const highRiskLog = Array.from(highRiskCounts.entries())
                        .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                        .join(', ');
                    const rule7Log = Array.from(rule7Counts.entries())
                        .map(([code, count]) => `${Data.countryMap[code] || code}: ${count} 筆`)
                        .join(', ');
                    Utils.addLog(`高風險交易分佈: ${highRiskLog}`);
                    if (rule7Log) {
                        Utils.addLog(`規則 #7 命中分佈: ${rule7Log}`);
                    }

                    const mapData = Array.from(countryCounts.entries()).map(([code, total]) => ({
                        name: Data.countryEChartsMap[code] || Data.countryMap[code] || code,
                        value: highRiskCounts.get(code) || 0,
                        totalCount: total,
                        highRiskCount: highRiskCounts.get(code) || 0,
                        rule7Count: rule7Counts.get(code) || 0,
                        highRiskPercentage: total ? Math.round(((highRiskCounts.get(code) || 0) / total) * 100) : 0,
                        originalCode: code
                    }));

                    chart.setOption({
                        backgroundColor: '#fff',
                        title: { text: '交易高風險地區分佈', subtext: '顏色深淺代表高風險交易數量', left: 'center', top: 10 },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => params.data
                                ? `${Data.countryMap[params.data.originalCode] || params.data.originalCode}<br/>
                                   總交易數量: ${params.data.totalCount} 筆<br/>
                                   高風險交易: ${params.data.highRiskCount} 筆<br/>
                                   規則 #7 命中: ${params.data.rule7Count} 筆<br/>
                                   高風險比例: ${params.data.highRiskPercentage}%`
                                : params.name
                        },
                        visualMap: {
                            show: true,
                            min: 0,
                            max: Math.max(...Array.from(highRiskCounts.values()), 1) * 1.5, // 進一步平滑顏色分佈
                            calculable: true,
                            inRange: { color: ['#fee2e2', '#ef4444'] },
                            text: ['高風險交易多', '高風險交易少'],
                            left: 'left',
                            top: 'bottom',
                            textStyle: { color: '#333' }
                        },
                        series: [{
                            name: '高風險交易',
                            type: 'map',
                            map: 'world',
                            aspectScale: 0.75,
                            roam: true,
                            zoom: 1.2,
                            selectedMode: false,
                            label: { show: false },
                            emphasis: { label: { show: true, fontSize: 10, color: '#333' }, itemStyle: { areaColor: '#fecaca' } },
                            data: mapData,
                            itemStyle: { areaColor: '#f5f5f5', borderColor: '#ccc', borderWidth: 0.5 }
                        }]
                    });

                    chart.hideLoading();
                    Utils.addLog(`地圖更新完成: 顯示 ${mapData.length} 個國家的高風險交易資料`);
                } catch (error) {
                    chart.hideLoading();
                    Utils.addLog(`地圖更新失敗: ${error.message}`);
                }
            },

            updateHourlyRiskChart() {
                const chart = this.charts.hourlyRisk;
                if (!chart) return;

                const hourlyData = Array.from({ length: 24 }, () => ({ low: 0, medium: 0, high: 0, total: 0 }));
                document.querySelectorAll('#transaction-table tr').forEach(row => {
                    const txId = row.getAttribute('data-id');
                    const tx = TransactionManager.transactions.find(t => t.id == txId);
                    if (!tx) return;

                    const hour = new Date(tx.timestamp).getHours();
                    const statusIcon = row.querySelector('td:first-child i');
                    const riskLevel = statusIcon?.classList.contains('text-success') ? 'low' :
                                     statusIcon?.classList.contains('text-warning') ? 'medium' :
                                     statusIcon?.classList.contains('text-danger') ? 'high' : 'medium';

                    hourlyData[hour][riskLevel]++;
                    hourlyData[hour].total++;
                });

                chart.setOption({
                    title: { text: '各時段交易風險分佈', subtext: '按小時統計的不同風險等級交易數量', left: 'center', top: 10 },
                    legend: { data: ['低風險', '中風險', '高風險'], left: '10%', bottom: 10 },
                    toolbox: { feature: { saveAsImage: {}, dataView: {} } },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        formatter: params => {
                            let total = 0;
                            let result = `${params[0].axisValueLabel}<br>`;
                            params.forEach(p => { total += p.value; result += `${p.marker} ${p.seriesName}: ${p.value}<br>`; });
                            return result + `<b>總計: ${total}</b>`;
                        }
                    },
                    xAxis: { data: Array.from({ length: 24 }, (_, i) => `${i}:00`), name: '小時', axisLine: { onZero: true }, splitLine: { show: false } },
                    yAxis: { name: '交易數量' },
                    grid: { left: '3%', right: '4%', bottom: '15%', top: '15%', containLabel: true },
                    series: [
                        { name: '低風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.low), itemStyle: { color: '#4CAF50' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } },
                        { name: '中風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.medium), itemStyle: { color: '#FFB300' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } },
                        { name: '高風險', type: 'bar', stack: '風險', data: hourlyData.map(h => h.high), itemStyle: { color: '#E57373' },
                          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.3)' } } }
                    ]
                });

                chart.hideLoading();
                Utils.addLog('已更新風險時間分佈圖表');
            },

            updateRiskPieChart() {
                const chart = this.charts.riskPie;
                if (!chart) return;

                const riskData = { high: 0, medium: 0, low: 0, total: 0 };
                document.querySelectorAll('#transaction-table tr').forEach(row => {
                    const txId = row.getAttribute('data-id');
                    if (!txId) return;
                    const statusIcon = row.querySelector('td:first-child i');
                    if (!statusIcon) return;
                    if (statusIcon.classList.contains('text-success')) riskData.low++;
                    else if (statusIcon.classList.contains('text-warning')) riskData.medium++;
                    else if (statusIcon.classList.contains('text-danger')) riskData.high++;
                    riskData.total++;
                });

                Utils.addLog(`風險分布分析: 高風險 ${riskData.high} 筆, 中風險 ${riskData.medium} 筆, 低風險 ${riskData.low} 筆, 總計 ${riskData.total} 筆`);

                chart.setOption({
                    title: { text: '交易風險分佈', subtext: `總計 ${riskData.total} 筆交易`, left: 'center' },
                    tooltip: { trigger: 'item', formatter: '{a} <br>{b}: {c} 筆 ({d}%)' },
                    legend: { orient: 'vertical', left: 'left', data: ['高風險', '中風險', '低風險'] },
                    series: [{
                        name: '風險等級',
                        type: 'pie',
                        radius: '50%',
                        data: [
                            { value: riskData.high, name: '高風險' },
                            { value: riskData.medium, name: '中風險' },
                            { value: riskData.low, name: '低風險' }
                        ],
                        itemStyle: {
                            color: params => ['#E57373', '#FFB300', '#4CAF50'][params.dataIndex]
                        },
                        emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } },
                        label: { show: true, formatter: '{b}: {c} 筆 ({d}%)' }
                    }]
                });

                chart.hideLoading();
                Utils.addLog('已更新風險分佈圓餅圖');
            },

            updateAll() {
                setTimeout(() => {
                    this.updateWorldMap();
                    this.updateHourlyRiskChart();
                    this.updateRiskPieChart();
                }, 500);
            }
        };

        // 初始化應用
        window.onload = () => {
            TransactionManager.generateTransactions();
            RuleManager.init();
        };
    </script>
</body>
</html>