<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風險規則引擎沙盒</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- 使用最新版的 ECharts 並載入世界地圖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://echarts.apache.org/examples/data/asset/geo/world.json"></script>
    <style>
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        .container-fluid {
            padding: 0 30px;
        }
        
        .title-area {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 20px;
            background-color: #fff;
            height: calc(100% - 20px);
        }
        
        .rule-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: move;
            position: relative;
            transition: all 0.2s;
            width: 100%; /* Ensure it takes full width */
            min-width: 250px; /* Minimum width to fit content */
        }
        
        .rule-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .rule-item.success {
            border-left: 4px solid #10b981;
            background-color: #ecfdf5;
        }
        
        .rule-item.warning {
            border-left: 4px solid #f59e0b;
            background-color: #fffbeb;
        }
        
        .rule-item.danger {
            border-left: 4px solid #ef4444;
            background-color: #fef2f2;
        }
        
        .rule-icon {
            display: inline-flex;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .rule-icon.success {
            background-color: #10b981;
            color: white;
        }
        
        .rule-icon.warning {
            background-color: #f59e0b;
            color: white;
        }
        
        .rule-icon.danger {
            background-color: #ef4444;
            color: white;
        }
        
        .rule-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .rule-item:hover .rule-actions {
            display: flex;
        }
        
        .rule-actions button, .btn-action {
            border: none;
            background: none;
            padding: 4px;
            margin-left: 4px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
        }
        
        .rule-actions button:hover, .btn-action:hover {
            color: #1890ff;
        }
        
        .rule-actions .fa-times:hover {
            color: #f5222d;
        }
        
        .handle {
            cursor: grab;
        }
        
        .drop-zone {
            min-height: 150px;
            max-height: 300px; /* 添加最大高度 */
            height: 300px; /* 固定高度 */
            border: 2px dashed #d9d9d9;
            border-radius: 4px;
            background-color: #fafafa;
            padding: 15px;
            margin-bottom: 15px;
            width: 100%;
            overflow-y: auto; /* 添加垂直捲軸 */
        }
        
        .drop-zone-placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }
        
        .drop-indicator {
            height: 2px;
            background-color: #1890ff;
            margin: 5px 0;
            display: none;
        }
        
        .drop-indicator.active {
            display: block;
        }
        
        .description-area {
            min-height: 80px;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
        }
        
        .transaction-table th {
            background-color: #001529;
            color: white;
            border: none;
        }
        
        .transaction-table tbody tr:nth-child(odd) {
            background-color: #f5f5f5;
        }
        
        .transaction-table tbody tr:hover {
            background-color: #e6f7ff;
        }
        
        .risk-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .risk-badge.success {
            background-color: #f6ffed;
            color: #52c41a;
        }
        
        .risk-badge.warning {
            background-color: #fffbe6;
            color: #faad14;
        }
        
        .risk-badge.danger {
            background-color: #fff1f0;
            color: #f5222d;
        }
        
        tr.highlighted {
            background-color: #e6f7ff !important;
        }
        
        .log-panel {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            max-height: 120px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .available-rules-card {
            max-height: 450px;
            overflow-y: auto;
        }
        
        /* Fixed width for rule panels */
        .rules-panel {
            width: 100%;
            min-width: 250px;
        }
        
        /* Rule number styling */
        .rule-number {
            display: inline-flex;
            min-width: 22px;
            height: 22px;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            margin-right: 6px;
            font-size: 12px;
            font-weight: bold;
            background-color: #e6e6e6;
            color: #333;
            flex-shrink: 0;
            padding: 0 4px;
        }

        /* 地圖相關樣式 */
        #world-map {
            height: 400px;
            width: 100%;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .map-controls {
            margin-bottom: 10px;
        }
        
        .map-legend {
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 100;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="title-area">
            <h2>風險規則引擎沙盒</h2>
            <p class="text-muted">拖放規則到執行區域以建立風險策略，可調整規則順序，點擊執行按鈕以應用規則</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <!-- Available rules - 左側 -->
                    <div class="col-md-6">
                        <div class="card available-rules-card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">可用規則</h5>
                                <div class="mb-3">
                                    <div class="btn-group w-100 mb-3">
                                        <button id="default-btn" class="btn btn-outline-primary active" onclick="applyDefaultRules()">預設決策</button>
                                        <button id="custom-btn" class="btn btn-outline-primary" onclick="clearRules()">自訂決策</button>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="risk-level" class="form-label">未命中規則默認風險：</label>
                                        <select class="form-select" id="risk-level">
                                            <option value="low">低風險</option>
                                            <option value="medium" selected>中風險</option>
                                            <option value="high">高風險</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="available-rules" class="rules-panel">
                                    <!-- Rules will be dynamically generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Policy selection - 右側 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">決策配置</h5>
                                
                                <!-- Drop zone for rules -->
                                <div id="execution-zone" class="drop-zone rules-panel" ondragover="allowDrop(event);" ondrop="drop(event)">
                                    <div class="drop-zone-placeholder" id="zone-placeholder">
                                        <div>拖放規則到此處</div>
                                        <small>從左側拖曳規則到此區域</small>
                                    </div>
                                    <div class="drop-indicator" id="drop-indicator"></div>
                                </div>
                                
                                <button class="btn btn-dark w-100" onclick="executeRules()">
                                    <i class="fas fa-play me-2"></i>執行規則
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description area - 下方 -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">規則描述</h5>
                                <div class="description-area" id="description-area">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle me-2 text-primary mt-1"></i>
                                        <p class="mb-0" id="rule-description">將游標懸停在規則上可查看詳細描述。規則順序決定風險評估優先級。點擊執行按鈕以應用規則。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log panel - 下方 -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">執行日誌</h5>
                                <div id="log-panel" class="log-panel"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right panel - Transaction Table -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title">交易監控</h5>
                            <div class="text-muted small">風險規則將套用於此表格中的交易</div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table transaction-table">
                                <thead>
                                    <tr>
                                        <th>狀態</th>
                                        <th>卡號</th>
                                        <th>時間</th>
                                        <th>國家</th>
                                        <th class="text-end">金額</th>
                                        <th class="text-end">設備風險</th>
                                        <th>命中規則</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-table">
                                    <!-- Transactions will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">交易地區分佈</h5>
                        <div class="text-muted small">各國家/地區交易數量</div>
                    </div>
                    
                    <!-- 地圖控制項 -->
                    <div class="map-controls d-flex justify-content-end mb-2">
                        <button id="zoom-reset" class="btn btn-sm btn-outline-secondary me-2">
                            <i class="fas fa-sync-alt"></i> 重置視圖
                        </button>
                    </div>
                    
                    <!-- 地圖容器 -->
                    <div id="world-map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 國家代碼對照表
        const countryMap = {
            '344': '香港',
            '408': '朝鮮',
            '702': '新加坡',
            '804': '烏克蘭',
            '840': '美國',
            '156': '中國',
            '392': '日本',
            '124': '加拿大',
            '276': '德國',
            '826': '英國',
            '036': '澳洲',
            '250': '法國',
            '356': '印度',
            '360': '印尼',
            '410': '南韓',
            '458': '馬來西亞',
            '484': '墨西哥',
            '643': '俄羅斯',
            '764': '泰國',
            '704': '越南'
        };

        // 國家代碼與 ECharts 名稱映射 - 擴展適配更多國家
        const countryEChartsMap = {
            '156': 'China',
            '344': 'China', // 香港作為中國的一部分在ECharts中顯示
            '392': 'Japan',
            '408': 'North Korea',
            '124': 'Canada', 
            '840': 'United States of America',
            '276': 'Germany',
            '826': 'United Kingdom',
            '702': 'Singapore',
            '804': 'Ukraine',
            // 添加更多常見國家映射
            '036': 'Australia',
            '250': 'France',
            '356': 'India',
            '360': 'Indonesia',
            '410': 'South Korea',
            '458': 'Malaysia',
            '484': 'Mexico',
            '643': 'Russia',
            '764': 'Thailand',
            '704': 'Vietnam'
        };
        
        // 定義所有規則
        const allRules = [
            { id: '1', text: '小金額且設備低風險', level: 'success', description: '交易金額低於500元且來自已知安全設備，可自動通過', 
              condition: function(tx) { return tx.amount < 500 && tx.deviceRisk > 0.2; }, 
              action: 'APPROVE' },
            { id: '2', text: '1天內驗證成功，累積金額小於$1000', level: 'success', description: '用戶在過去24小時內已經完成驗證，且累積交易金額低於1000元', 
              condition: function(tx) { return tx.isVerified && tx.cumulativeAmount < 1000 && isWithin24Hours(tx.timestamp); }, 
              action: 'APPROVE' },
            { id: '3', text: '設備中風險', level: 'warning', description: '使用者的設備風險評分在0至0.5之間，建議額外監控', 
              condition: function(tx) { return tx.deviceRisk >= 0 && tx.deviceRisk <= 0.5; }, 
              action: 'REVIEW' },
            { id: '4', text: '中高金額', level: 'warning', description: '單筆交易金額超過300元，需要額外審核', 
              condition: function(tx) { return tx.amount > 300; }, 
              action: 'REVIEW' },
            { id: '5', text: '中高金額且來自高風險國家', level: 'danger', description: '偵測交易金額超過500元且來源IP位於高風險國家清單中的交易', 
              condition: function(tx) { return tx.amount > 500 && (tx.countryCode === '408' || tx.countryCode === '804'); }, 
              action: 'BLOCK' },
            { id: '6', text: '設備高風險', level: 'danger', description: '設備風險評分為負數，可能表示有異常活動', 
              condition: function(tx) { return tx.deviceRisk < 0; }, 
              action: 'BLOCK' },
            { id: '7', text: '短時間內來自不同國家', level: 'danger', description: '偵測同一卡號在60分鐘內從不同國家發起交易，可能為盜刷', 
              condition: function(tx) { return hasMultipleCountriesIn60Min(tx, transactions); }, 
              action: 'BLOCK' }
        ];
        
        // 預設規則ID列表（按優先順序）
        const defaultRuleIds = ['7', '5', '6', '4', '3'];
        
        // 檢查是否在過去24小時內
        function isWithin24Hours(timestamp) {
            const now = new Date();
            const txTime = new Date(timestamp);
            const hoursDiff = (now - txTime) / (1000 * 60 * 60);
            return hoursDiff <= 24;
        }
        
        // 檢查是否在60分鐘內有來自不同國家的交易
        function hasMultipleCountriesIn60Min(transaction, allTransactions) {
            const card = transaction.card;
            const txTime = new Date(transaction.timestamp);
            const countriesInTimeWindow = new Set();
            
            // 收集60分鐘內所有交易的國家
            allTransactions.forEach(function(tx) {
                if (tx.card === card) {
                    const otherTxTime = new Date(tx.timestamp);
                    const minutesDiff = Math.abs((txTime - otherTxTime) / (1000 * 60));
                    
                    if (minutesDiff <= 60) {
                        countriesInTimeWindow.add(tx.countryCode);
                    }
                }
            });
            
            // 如果有多個國家則返回真
            return countriesInTimeWindow.size > 1;
        }
        
        // 生成隨機時間
        function getRandomTime(minHoursAgo, maxHoursAgo) {
            minHoursAgo = minHoursAgo || 0;
            maxHoursAgo = maxHoursAgo || 48;
            const now = new Date();
            const hoursAgo = Math.random() * (maxHoursAgo - minHoursAgo) + minHoursAgo;
            const timestamp = new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);
            return timestamp;
        }
        
        // 格式化日期時間
        function formatDateTime(date) {
            return date.toLocaleString('zh-TW', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        // 交易數據
        const transactions = [
            { id: 1, card: '05f2c088cf', countryCode: '344', amount: 100, deviceRisk: 0.2, isVerified: true, cumulativeAmount: 300, timestamp: getRandomTime(0, 5) },
            { id: 2, card: '454653c25', countryCode: '408', amount: 9900, deviceRisk: -0.6, isVerified: false, cumulativeAmount: 9900, timestamp: getRandomTime(1, 2) },
            { id: 3, card: '8yu723321', countryCode: '840', amount: 20, deviceRisk: 0.9, isVerified: true, cumulativeAmount: 100, timestamp: getRandomTime(20, 30) },
            { id: 4, card: '745h625g4', countryCode: '702', amount: 700, deviceRisk: 0, isVerified: true, cumulativeAmount: 2800, timestamp: getRandomTime(0, 12) },
            { id: 5, card: '745h625g5', countryCode: '804', amount: 200, deviceRisk: -0.8, isVerified: false, cumulativeAmount: 800, timestamp: getRandomTime(10, 15) },
            { id: 6, card: '23662kop6', countryCode: '702', amount: 290, deviceRisk: 0.5, isVerified: true, cumulativeAmount: 1200, timestamp: getRandomTime(36, 48) },
            { id: 7, card: '782642ds7', countryCode: '344', amount: 800, deviceRisk: 0.3, isVerified: true, cumulativeAmount: 800, timestamp: getRandomTime(2, 4) },
            // 添加跨國測試案例 - 同一卡號，不同國家，時間接近
            { id: 8, card: 'crossb0rd3r', countryCode: '156', amount: 450, deviceRisk: 0.1, isVerified: true, cumulativeAmount: 450, timestamp: getRandomTime(0.9, 1) },
            { id: 9, card: 'crossb0rd3r', countryCode: '392', amount: 380, deviceRisk: 0.2, isVerified: true, cumulativeAmount: 830, timestamp: getRandomTime(0.8, 0.9) }
        ];
        
        // DOM元素
        var executionZone, availableRules, placeholder, dropIndicator, defaultBtn, customBtn, transactionTable, logPanel;
        
        // ECharts 世界地圖相關代碼
        let worldMap;
                
        // 初始化
        window.onload = function() {
            executionZone = document.getElementById('execution-zone');
            availableRules = document.getElementById('available-rules');
            placeholder = document.getElementById('zone-placeholder');
            dropIndicator = document.getElementById('drop-indicator');
            defaultBtn = document.getElementById('default-btn');
            customBtn = document.getElementById('custom-btn');
            transactionTable = document.getElementById('transaction-table');
            logPanel = document.getElementById('log-panel');
            
            initializeRules();
            loadTransactions();
            applyDefaultRules();
            
            // 初始化世界地圖
            initWorldMap();
            
            // 重置地圖按鈕事件
            document.getElementById('zoom-reset').addEventListener('click', function() {
                if (worldMap) {
                    worldMap.dispatchAction({
                        type: 'restore'
                    });
                }
            });
        };
        
        
    
    // 更新世界地圖的交易資料 - 修改為顯示高風險交易數量
    function updateWorldMap() {
    if (!worldMap) {
        console.error('地圖未初始化');
        return;
    }
    
    // 檢查地圖是否已成功註冊
    if (!echarts.getMap('world')) {
        console.error('世界地圖數據尚未完全加載');
        addLog('地圖數據尚未完全載入，無法更新');
        return;
    }
    
    // 顯示更新中狀態
    worldMap.showLoading({
        text: '更新地圖數據...',
        maskColor: 'rgba(255, 255, 255, 0.5)',
        textColor: '#1890ff'
    });
    
    try {
        // 統計每個國家的交易數量和高風險交易數量
        const countryCounts = {};
        const countryHighRiskCounts = {};
        
        // 獲取執行過風險規則的交易
        const rows = document.querySelectorAll('#transaction-table tr');
        
        rows.forEach(function(row) {
            const txId = row.getAttribute('data-id');
            if (!txId) return;
            
            const tx = transactions.find(t => t.id == txId);
            if (!tx) return;
            
            // 檢查交易狀態 - 是否為高風險
            const statusIcon = row.querySelector('td:first-child i');
            let isHighRisk = false;
            
            if (statusIcon && statusIcon.classList.contains('text-danger')) {
                isHighRisk = true;
            }
            
            // 累計數量和高風險交易
            if (!countryCounts[tx.countryCode]) {
                countryCounts[tx.countryCode] = 0;
                countryHighRiskCounts[tx.countryCode] = 0;
            }
            
            countryCounts[tx.countryCode]++;
            if (isHighRisk) {
                countryHighRiskCounts[tx.countryCode]++;
            }
        });
        
        // 格式化 ECharts 資料
        const mapData = Object.keys(countryCounts).map(function(code) {
            // 獲取國家的ECharts名稱
            const echartsName = countryEChartsMap[code];
            const totalCount = countryCounts[code];
            const highRiskCount = countryHighRiskCounts[code];
            
            // 如果找不到對應，使用ISO數字代碼
            return {
                name: echartsName || code,
                value: highRiskCount,  // 使用高風險交易數量作為值
                totalCount: totalCount,
                highRiskCount: highRiskCount,
                highRiskPercentage: totalCount > 0 ? Math.round((highRiskCount / totalCount) * 100) : 0,
                // 儲存原始代碼用於提示框
                originalCode: code
            };
        });
        
        // 找出最大的高風險交易數量，至少為1
        const maxHighRiskCount = Math.max(...Object.values(countryHighRiskCounts), 1);
        
        // 地圖配置
        const option = {
            backgroundColor: '#fff',
            title: {
                text: '交易高風險地區分佈',
                subtext: '顏色深淺代表高風險交易數量',
                left: 'center',
                top: 10
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.data && params.data.originalCode) {
                        const countryCode = params.data.originalCode;
                        const localName = countryMap[countryCode] || countryCode;
                        const totalCount = params.data.totalCount;
                        const highRiskCount = params.data.highRiskCount;
                        const highRiskPercentage = params.data.highRiskPercentage;
                        
                        return `${localName}<br/>
                                總交易數量: ${totalCount} 筆<br/>
                                高風險交易: ${highRiskCount} 筆<br/>
                                高風險比例: ${highRiskPercentage}%`;
                    }
                    return params.name;
                }
            },
            visualMap: {
                show: true,
                min: 0,
                max: maxHighRiskCount,
                calculable: true,
                inRange: {
                    color: ['#fee2e2', '#ef4444']  // 從淺紅到深紅
                },
                text: ['高風險交易多', '高風險交易少'],
                left: 'left',
                top: 'bottom',
                textStyle: {
                    color: '#333'
                }
            },
            series: [
                {
                    name: '高風險交易',
                    type: 'map',
                    map: 'world',
                    aspectScale: 0.75,
                    roam: true,
                    zoom: 1.2,
                    selectedMode: false,
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 10,
                            color: '#333'
                        },
                        itemStyle: {
                            areaColor: '#fecaca'
                        }
                    },
                    data: mapData,
                    itemStyle: {
                        areaColor: '#f5f5f5',
                        borderColor: '#ccc',
                        borderWidth: 0.5
                    }
                }
            ]
        };
        
        // 設定配置並渲染
        worldMap.setOption(option);
        worldMap.hideLoading();
        
        addLog('地圖更新完成: 顯示 ' + mapData.length + ' 個國家的高風險交易資料');
    } catch (error) {
        console.error('更新地圖時發生錯誤:', error);
        worldMap.hideLoading();
        addLog('地圖更新失敗: ' + error.message);
    }
}

    // 初始化世界地圖
    function initWorldMap() {
        const chartDom = document.getElementById('world-map');
        if (!chartDom) return;
        
        // 初始化ECharts實例
        worldMap = echarts.init(chartDom);
        
        // 顯示加載中狀態
        worldMap.showLoading({
            text: '加載世界地圖數據中...',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            textColor: '#1890ff'
        });
        
        // 註冊世界地圖
        fetch('./wMap.json')  // 使用相對路徑指向你存放的位置
        .then(response => {
            if (!response.ok) {
                throw new Error('無法獲取地圖數據: ' + response.statusText);
            }
            return response.json();
        })
        .then(worldJson => {
            // 地圖數據加載成功
            echarts.registerMap('world', worldJson);
            worldMap.hideLoading();
            addLog('世界地圖數據加載成功');
            
            // 嘗試設置初始地圖視圖
            try {
                setInitialMapView();
            } catch(e) {
                console.error('設置初始視圖失敗:', e);
                addLog('初始視圖設置失敗，但地圖已加載');
            }
        })
        .catch(error => {
            addLog('加載地圖數據失敗: ' + error.message);
            // 可以提供一個備用選項或顯示錯誤信息
        });
        
        // 處理視窗大小調整
        window.addEventListener('resize', function() {
            if (worldMap) {
                worldMap.resize();
            }
        });
    }

    // 設置初始地圖視圖 (如果這個函數不存在，可以添加一個空函數)
    function setInitialMapView() {
        if (worldMap) {
            worldMap.setOption({
                series: [{
                    center: [0, 30],
                    zoom: 1.2
                }]
            });
        }
    }

        // 加載交易資料
        function loadTransactions() {
            transactionTable.innerHTML = '';
            
            transactions.forEach(function(tx) {
                const row = document.createElement('tr');
                row.setAttribute('data-id', tx.id);
                
                row.innerHTML = 
                    '<td><i class="fas fa-circle-notch fa-spin text-secondary"></i></td>' +
                    '<td class="font-monospace">' + tx.card + '</td>' +
                    '<td>' + formatDateTime(tx.timestamp) + '</td>' +
                    '<td>' + (countryMap[tx.countryCode] || tx.countryCode) + '</td>' +
                    '<td class="text-end">' + tx.amount.toLocaleString() + '</td>' +
                    '<td class="text-end"><span class="risk-badge ' + 
                    (tx.deviceRisk > 0.3 ? 'success' : tx.deviceRisk >= 0 ? 'warning' : 'danger') + 
                    '">' + tx.deviceRisk.toFixed(1) + '</span></td>' +
                    '<td></td>';
                
                transactionTable.appendChild(row);
            });
        }
        
        // 初始化所有規則
        function initializeRules() {
            availableRules.innerHTML = '';
            allRules.forEach(function(rule) {
                addRuleToAvailable(rule);
            });
        }
        
        // 顯示規則描述
        function showDescription(element) {
            const description = element.getAttribute('data-description');
            document.getElementById('rule-description').textContent = description;
        }
        
        // 添加規則到可用區域
        function addRuleToAvailable(rule) {
            if (document.querySelector('#available-rules [data-id="' + rule.id + '"]')) {
                return;
            }
            
            const ruleElement = document.createElement('div');
            ruleElement.className = 'rule-item ' + rule.level;
            ruleElement.draggable = true;
            ruleElement.setAttribute('ondragstart', 'dragStart(event)');
            ruleElement.setAttribute('data-id', rule.id);
            ruleElement.setAttribute('data-level', rule.level);
            ruleElement.setAttribute('data-description', rule.description);
            ruleElement.setAttribute('onmouseenter', 'showDescription(this)');
            
            ruleElement.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<div class="rule-number">' + rule.id + '</div>' +
                    '<div class="rule-icon ' + rule.level + '">' +
                    '<i class="fas fa-' + (rule.level === 'success' ? 'check' : rule.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle') + '"></i>' +
                    '</div>' +
                    '<span>' + rule.text + '</span>' +
                '</div>' +
                '<div class="rule-actions">' +
                    '<i class="fas fa-arrows-alt handle"></i>' +
                '</div>';
            
            availableRules.appendChild(ruleElement);
        }
        
        // 創建規則克隆（用於執行區域）
        function createRuleClone(rule) {
            let ruleId, ruleLevel, ruleDescription, ruleText;
            
            if (rule instanceof Element) {
                ruleId = rule.getAttribute('data-id');
                ruleLevel = rule.getAttribute('data-level');
                ruleDescription = rule.getAttribute('data-description');
                ruleText = rule.querySelector('.d-flex span').textContent;
            } else {
                ruleId = rule.id;
                ruleLevel = rule.level;
                ruleDescription = rule.description;
                ruleText = rule.text;
            }
            
            const clone = document.createElement('div');
            clone.className = 'rule-item ' + ruleLevel;
            clone.draggable = true;
            clone.setAttribute('ondragstart', 'dragStart(event)');
            clone.setAttribute('data-id', ruleId);
            clone.setAttribute('data-level', ruleLevel);
            clone.setAttribute('data-description', ruleDescription);
            clone.setAttribute('onmouseenter', 'showDescription(this)');
            
            clone.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<div class="rule-number">' + ruleId + '</div>' +
                    '<div class="rule-icon ' + ruleLevel + '">' +
                    '<i class="fas fa-' + (ruleLevel === 'success' ? 'check' : ruleLevel === 'warning' ? 'exclamation-triangle' : 'exclamation-circle') + '"></i>' +
                    '</div>' +
                    '<span>' + ruleText + '</span>' +
                '</div>' +
                '<div class="rule-actions">' +
                    '<i class="fas fa-arrows-alt handle"></i>' +
                    '<button class="btn-action" onclick="removeRule(this.parentNode.parentNode)">' +
                    '<i class="fas fa-times"></i>' +
                    '</button>' +
                '</div>';
            
            return clone;
        }
        
        // 拖動開始處理
        function dragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.getAttribute('data-id'));
            event.target.style.opacity = '0.4';
        }
        
        // 允許放置
        function allowDrop(event) {
            event.preventDefault();
            showDropIndicator(event);
        }
        
        // 顯示放置指示器
        function showDropIndicator(event) {
            const executionItems = Array.from(executionZone.children).filter(function(child) {
                return child.classList.contains('rule-item');
            });
            
            if (executionItems.length === 0) {
                executionZone.insertBefore(dropIndicator, placeholder);
                dropIndicator.classList.add('active');
                return;
            }
            
            let closestItem = null;
            let closestDistance = Number.MAX_VALUE;
            let position = 'before';
            
            executionItems.forEach(function(item) {
                const rect = item.getBoundingClientRect();
                const itemMiddle = rect.top + rect.height / 2;
                const distance = Math.abs(event.clientY - itemMiddle);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                    position = event.clientY < itemMiddle ? 'before' : 'after';
                }
            });
            
            if (closestItem) {
                if (position === 'before') {
                    executionZone.insertBefore(dropIndicator, closestItem);
                } else {
                    executionZone.insertBefore(dropIndicator, closestItem.nextSibling);
                }
                dropIndicator.classList.add('active');
            }
        }
        
        // 放置處理
        function drop(event) {
            event.preventDefault();
            
            dropIndicator.classList.remove('active');
            
            const ruleId = event.dataTransfer.getData('text/plain');
            const sourceRule = document.querySelector('[data-id="' + ruleId + '"]');
            
            if (!sourceRule) return;
            
            sourceRule.style.opacity = '';
            
            const isFromAvailable = sourceRule.parentNode.id === 'available-rules';
            
            if (isFromAvailable) {
                const rule = allRules.find(function(r) { return r.id === ruleId; });
                if (!rule) return;
                
                const newRule = createRuleClone(rule);
                const insertBefore = dropIndicator.nextSibling || placeholder;
                executionZone.insertBefore(newRule, insertBefore);
                
                sourceRule.remove();
            } else {
                const insertBefore = dropIndicator.nextSibling || placeholder;
                executionZone.insertBefore(sourceRule, insertBefore);
            }
            
            updatePlaceholder();
            updateButtonState();
        }
        
        // 移除規則
        function removeRule(rule) {
            const ruleId = rule.getAttribute('data-id');
            
            const originalRule = allRules.find(function(r) { return r.id === ruleId; });
            if (originalRule) {
                addRuleToAvailable(originalRule);
                rule.remove();
                
                updatePlaceholder();
                updateButtonState();
            }
        }
        
        // 更新佔位符顯示
        function updatePlaceholder() {
            const hasRules = executionZone.querySelectorAll('.rule-item').length > 0;
            placeholder.style.display = hasRules ? 'none' : 'block';
        }
        
        // 更新按鈕狀態
        function updateButtonState() {
            const currentRules = Array.from(
                executionZone.querySelectorAll('.rule-item')
            ).map(function(rule) { 
                return rule.getAttribute('data-id'); 
            });
            
            const isDefault = isDefaultConfiguration(currentRules);
            
            defaultBtn.classList.toggle('active', isDefault);
            customBtn.classList.toggle('active', !isDefault);
        }
        
        // 檢查是否為預設配置
        function isDefaultConfiguration(currentRules) {
            if (currentRules.length !== defaultRuleIds.length) return false;
            
            for (let i = 0; i < defaultRuleIds.length; i++) {
                if (currentRules[i] !== defaultRuleIds[i]) return false;
            }
            
            return true;
        }
        
        // 應用預設規則
        function applyDefaultRules() {
            clearRules();
            
            defaultRuleIds.forEach(function(id) {
                const rule = allRules.find(function(r) { return r.id === id; });
                if (rule) {
                    const newRule = createRuleClone(rule);
                    executionZone.insertBefore(newRule, placeholder);
                    
                    const availableRule = document.querySelector('#available-rules [data-id="' + id + '"]');
                    if (availableRule) {
                        availableRule.remove();
                    }
                }
            });
            
            updatePlaceholder();
            updateButtonState();
        }
        
        // 清空所有規則
        function clearRules() {
            const executionRules = executionZone.querySelectorAll('.rule-item');
            executionRules.forEach(function(rule) {
                const ruleId = rule.getAttribute('data-id');
                rule.remove();
                
                const originalRule = allRules.find(function(r) { return r.id === ruleId; });
                if (originalRule) {
                    addRuleToAvailable(originalRule);
                }
            });
            
            updatePlaceholder();
            
            // 重置交易狀態
            resetTransactionStatus();
        }
        
        // 重置交易狀態
        function resetTransactionStatus() {
            const transactionRows = transactionTable.querySelectorAll('tr');
            
            transactionRows.forEach(function(row) {
                const statusCell = row.querySelector('td:first-child');
                const hitRuleCell = row.querySelector('td:last-child');
                
                statusCell.innerHTML = '<i class="fas fa-circle-notch fa-spin text-secondary"></i>';
                hitRuleCell.textContent = '';
                
                row.classList.remove('highlighted');
            });
        }
        
        // 添加日誌
        function addLog(message) {
            const logEntry = document.createElement('div');
            logEntry.textContent = '> ' + message;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        // 清空日誌
        function clearLog() {
            logPanel.innerHTML = '';
        }
        
        // 執行規則引擎
        function executeRules() {
            clearLog();
            resetTransactionStatus();
            
            const activeRuleElements = executionZone.querySelectorAll('.rule-item');
            const riskLevel = document.getElementById('risk-level').value;
            
            addLog('風險等級設置為: ' + riskLevel);
            
            if (activeRuleElements.length === 0) {
                addLog('沒有可用規則，所有交易設為' + riskLevel + '風險');
                
                // 處理沒有規則時的預設行為
                transactions.forEach(function(tx) {
                    const row = document.querySelector('#transaction-table tr[data-id="' + tx.id + '"]');
                    const statusCell = row.querySelector('td:first-child');
                    const hitRuleCell = row.querySelector('td:last-child');
                    
                    hitRuleCell.textContent = '未命中任何規則';
                    
                    // 根據風險等級決定未命中規則的交易處理方式
                    if (riskLevel === 'low') {
                        statusCell.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    } else if (riskLevel === 'medium') {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    } else if (riskLevel === 'high') {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                    }
                    
                    row.classList.add('highlighted');
                });
                
                updateWorldMap();
                return;
            }
            
            // 獲取當前活動規則
            const activeRules = Array.from(activeRuleElements).map(function(ruleElement) {
                const ruleId = ruleElement.getAttribute('data-id');
                return allRules.find(function(r) { return r.id === ruleId; });
            }).filter(function(rule) { return rule !== undefined; });
            
            // 處理每個交易
            transactions.forEach(function(tx) {
                processTransaction(tx, activeRules, riskLevel);
            });
            
            // 更新世界地圖
            updateWorldMap();
        }
        
        // 處理單筆交易
        function processTransaction(transaction, activeRules, riskLevel) {
            const row = document.querySelector('#transaction-table tr[data-id="' + transaction.id + '"]');
            const statusCell = row.querySelector('td:first-child');
            const hitRuleCell = row.querySelector('td:last-child');
            
            let matchedRule = null;
            // 初始動作根據風險等級設置
            let action = getDefaultActionByRiskLevel(riskLevel);
            
            // 依序執行規則
            for (let i = 0; i < activeRules.length; i++) {
                const rule = activeRules[i];
                if (rule.condition(transaction)) {
                    matchedRule = rule;
                    action = rule.action;
                    
                    // 基於風險等級調整行動
                    if (riskLevel === 'low' && action === 'BLOCK') {
                        action = 'REVIEW';
                    } else if (riskLevel === 'high' && action === 'APPROVE') {
                        action = 'REVIEW';
                    }
                    
                    // 記錄命中的規則
                    hitRuleCell.innerHTML = '<span class="badge bg-light text-dark">#' + rule.id + '</span> ' + rule.text;
                    addLog('交易 ' + transaction.card + ' 命中規則 #' + rule.id + ': ' + rule.text);
                    
                    break; // 找到第一個符合的規則就停止
                }
            }
            
            // 更新交易狀態
            if (action === 'APPROVE') {
                statusCell.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                row.classList.add('highlighted');
            } else if (action === 'REVIEW') {
                statusCell.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                row.classList.add('highlighted');
            } else if (action === 'BLOCK') {
                statusCell.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                row.classList.add('highlighted');
            } else {
                statusCell.innerHTML = '<i class="fas fa-question-circle text-secondary"></i>';
            }
            
            // 沒有命中規則的情況
            if (!matchedRule) {
                hitRuleCell.textContent = '未命中任何規則';
                addLog('交易 ' + transaction.card + ' 未命中任何規則，採用' + riskLevel + '風險預設行為');
            }
        }
        
        // 根據風險等級獲取預設行為
        function getDefaultActionByRiskLevel(riskLevel) {
            switch(riskLevel) {
                case 'low':
                    return 'APPROVE';
                case 'medium':
                    return 'REVIEW';
                case 'high':
                    return 'BLOCK';
                default:
                    return 'REVIEW';
            }
        }
        // 初始化世界地圖
function initWorldMap() {
    const chartDom = document.getElementById('world-map');
    if (!chartDom) return;
    
    // 初始化ECharts實例
    worldMap = echarts.init(chartDom);
    
    // 顯示加載中狀態
    worldMap.showLoading({
        text: '加載世界地圖數據中...',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        textColor: '#1890ff'
    });
    
    // 註冊世界地圖
    fetch('./wMap.json')  // 使用相對路徑指向你存放的位置
    .then(response => {
        if (!response.ok) {
        throw new Error('無法獲取地圖數據: ' + response.statusText);
        }
        return response.json();
    })
    .then(worldJson => {
        // 地圖數據加載成功
        echarts.registerMap('world', worldJson);
        worldMap.hideLoading();
        addLog('世界地圖數據加載成功');
        // 初始地圖視圖
        setInitialMapView();
    })
    .catch(error => {
        addLog('加載地圖數據失敗: ' + error.message);
        // 可以提供一個備用選項或顯示錯誤信息
    });
    
    // 處理視窗大小調整
    window.addEventListener('resize', function() {
        if (worldMap) {
            worldMap.resize();
        }
    });
}
function getColorByRiskLevel(riskLevel) {
    // Risk level is expected to be a value between 1-3
    // Where 1 is low risk, 2 is medium risk, and 3 is high risk
    
    if (riskLevel < 1.67) {
        // Low risk - green
        return '#d4edda';  // Light green
    } else if (riskLevel < 2.33) {
        // Medium risk - yellow
        return '#fff3cd';  // Light yellow
    } else {
        // High risk - red
        return '#f8d7da';  // Light red
    }
}
</script>
</body>
</html>