<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風險規則引擎沙盒</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script> 
</head>
<body>
    <div class="container-fluid">
        <div class="title-area">
            <h2>風險規則引擎沙盒</h2>
            <p class="text-muted">拖放規則到執行區域以建立風險策略，可調整規則順序，點擊執行按鈕以應用規則</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <!-- Available rules - 左側 -->
                    <div class="col-md-6">
                        <div class="card available-rules-card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">可用規則</h5>
                                <div class="mb-3">
                                    <div class="btn-group w-100 mb-3">
                                        <button id="default-btn" class="btn btn-outline-primary active" onclick="applyDefaultRules()">預設決策</button>
                                        <button id="custom-btn" class="btn btn-outline-primary" onclick="clearRules()">自訂決策</button>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="risk-level" class="form-label">未命中規則默認風險：</label>
                                        <select class="form-select" id="risk-level">
                                            <option value="low">低風險</option>
                                            <option value="medium" selected>中風險</option>
                                            <option value="high">高風險</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="available-rules" class="rules-panel">
                                    <!-- Rules will be dynamically generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Policy selection - 右側 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">決策配置</h5>
                                
                                <!-- Drop zone for rules -->
                                <div id="execution-zone" class="drop-zone rules-panel" ondragover="allowDrop(event);" ondrop="drop(event)">
                                    <div class="drop-zone-placeholder" id="zone-placeholder">
                                        <div>拖放規則到此處</div>
                                        <small>從左側拖曳規則到此區域</small>
                                    </div>
                                    <div class="drop-indicator" id="drop-indicator"></div>
                                </div>
                                
                                <button class="btn btn-dark w-100" onclick="executeRules()">
                                    <i class="fas fa-play me-2"></i>執行規則
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description area - 下方 -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">規則描述</h5>
                                <div class="description-area" id="description-area">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle me-2 text-primary mt-1"></i>
                                        <p class="mb-0" id="rule-description">將游標懸停在規則上可查看詳細描述。規則順序決定風險評估優先級。點擊執行按鈕以應用規則。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log panel - 下方 -->
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title border-bottom pb-2">執行日誌</h5>
                                <div id="log-panel" class="log-panel"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right panel - Transaction Table -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title">交易監控</h5>
                            <div class="text-muted small">風險規則將套用於此表格中的交易</div>
                        </div>
                        
                        <div class="table-responsive fixed-width-container">
                            <table class="table transaction-table">
                                <thead>
                                    <tr>
                                        <th>狀態</th>
                                        <th>卡號</th>
                                        <th>時間</th>
                                        <th>國家</th>
                                        <th class="text-end">金額</th>
                                        <th class="text-end">設備風險</th>
                                        <th>命中規則</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-table">
                                    <!-- 交易記錄動態生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">交易地區分佈</h5>
                        <div class="text-muted small">各國家/地區交易數量</div>
                    </div>
                    <!-- 地圖容器 -->
                    <div id="world-map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="row">
            
        </div>
    </div>
    
    <script>
        // 國家代碼對照表
        const countryMap = {
            '344': '中國',
            '408': '朝鮮',
            '702': '新加坡',
            '840': '美國',
            '156': '中國',
            '392': '日本',
            '124': '加拿大',
            '276': '德國',
            '826': '英國',
            '036': '澳洲',
            '250': '法國',
            '356': '印度',
            '360': '印尼',
            '410': '南韓',
            '458': '馬來西亞',
            '484': '墨西哥',
            '643': '俄羅斯',
            '764': '泰國',
            '704': '越南',
            '158': '臺灣',  
            '496': '蒙古',
            '608': '菲律賓',
            '418': '寮國',
            '104': '緬甸',
            '116': '柬埔寨',
            '096': '汶萊',
            '398': '哈薩克',
            '795': '土庫曼',
            '860': '烏茲別克',
            '762': '塔吉克',
            '417': '吉爾吉斯',
            '051': '亞美尼亞',
            '031': '亞塞拜然',
            '268': '喬治亞',
            '368': '伊拉克',
            '364': '伊朗',
            '682': '沙烏地阿拉伯',
            '784': '阿拉伯聯合大公國',
            '634': '卡達',
            '414': '科威特',
            '512': '阿曼',
            '887': '葉門',
            '760': '敘利亞',
            '422': '黎巴嫩',
            '400': '約旦',
            '376': '以色列',
            '586': '巴基斯坦',
            '004': '阿富汗',
            '050': '孟加拉',
            '144': '斯里蘭卡',
            '524': '尼泊爾',
            '064': '不丹',
            '462': '馬爾地夫',
            '203': '捷克',
            '348': '匈牙利',
            '616': '波蘭',
            '040': '奧地利',
            '380': '義大利',
            '756': '瑞士',
            '724': '西班牙',
            '620': '葡萄牙',
            '056': '比利時',
            '528': '荷蘭',
            '578': '挪威',
            '752': '瑞典',
            '246': '芬蘭',
            '208': '丹麥',
            '372': '愛爾蘭',
            '300': '希臘',
            '642': '羅馬尼亞',
            '100': '保加利亞',
            '688': '塞爾維亞',
            '191': '克羅埃西亞',
            '705': '斯洛維尼亞',
            '703': '斯洛伐克',
            '440': '立陶宛',
            '428': '拉脫維亞',
            '233': '愛沙尼亞',
            '498': '摩爾多瓦',
            '804': '烏克蘭',
            '112': '白俄羅斯',
            '710': '南非',
            '404': '肯亞',
            '231': '衣索比亞',
            '818': '埃及',
            '504': '摩洛哥',
            '788': '突尼西亞',
            '012': '阿爾及利亞',
            '288': '迦納',
            '566': '奈及利亞',
            '180': '剛果',
            '024': '安哥拉',
            '716': '辛巴威',
            '516': '納米比亞',
            '072': '波札那',
            '748': '史瓦濟蘭',
            '508': '莫三比克',
            '894': '尚比亞',
            '834': '坦尚尼亞',
            '800': '烏干達',
            '450': '馬達加斯加',
            '480': '模里西斯',
            '175': '馬約特',
            '638': '留尼旺',
            '732': '西撒哈拉',
            '466': '馬利',
            '562': '尼日',
            '148': '查德',
            '204': '貝南',
            '768': '多哥',
            '270': '甘比亞',
            '324': '幾內亞',
            '430': '賴比瑞亞',
            '384': '象牙海岸',
            '854': '布吉納法索',
            '729': '蘇丹',
            '728': '南蘇丹',
            '686': '塞內加爾',
            '478': '茅利塔尼亞',
            '831': '格瑞那達',
            '032': '阿根廷',
            '076': '巴西',
            '170': '哥倫比亞',
            '604': '秘魯',
            '152': '智利',
            '862': '委內瑞拉',
            '218': '厄瓜多',
            '068': '玻利維亞',
            '600': '巴拉圭',
            '858': '烏拉圭',
            '328': '蓋亞那',
            '740': '蘇利南',
            '238': '福克蘭群島',
            '320': '瓜地馬拉',
            '591': '巴拿馬',
            '188': '哥斯大黎加',
            '340': '宏都拉斯',
            '222': '薩爾瓦多',
            '558': '尼加拉瓜',
            '084': '貝里斯',
            '192': '古巴',
            '332': '海地',
            '214': '多明尼加',
            '388': '牙買加',
            '052': '巴巴多斯',
            '028': '安地卡及巴布達',
            '044': '巴哈馬',
            '780': '千里達',
            '010': '南極洲',
            '744': '亞速爾群島',
            '474': '馬提尼克',
            '312': '瓜德羅普',
            '660': '安圭拉',
            '254': '法屬圭亞那',
            '500': '蒙特塞拉特',
            '654': '聖赫勒拿',
            '090': '所羅門群島',
            '548': '萬那杜',
            '242': '斐濟',
            '316': '關島',
            '583': '密克羅尼西亞',
            '580': '北馬里亞納',
            '585': '帛琉',
            '016': '美屬薩摩亞',
            '882': '薩摩亞',
            '296': '吉里巴斯',
            '776': '東加',
            '570': '紐埃',
            '612': '皮特肯群島',
            '162': '聖誕島',
            '334': '赫德島和麥克唐納群島',
            '574': '諾福克島',
            '520': '瑙魯',
            '798': '吐瓦魯',
            '136': '開曼群島',
            '796': '特克斯和凱科斯群島',
            '092': '英屬維京群島',
            '772': '托克勞',
            '876': '瓦利斯和富圖納',
            '184': '庫克群島',
            '258': '法屬波利尼西亞',
            '540': '新喀里多尼亞'
        };

         // 國家代碼與 ECharts 名稱映射 - 擴展適配更多國家
         const countryEChartsMap = {
            // 原有映射
            '156': 'China',
            '344': 'China', // 香港作為中國的一部分在ECharts中顯示
            '158': 'Taiwan', // 添加台湾
            '392': 'Japan',
            '408': 'North Korea',
            '124': 'Canada', 
            '840': 'United States of America',
            '276': 'Germany',
            '826': 'United Kingdom',
            '702': 'Singapore',
            '804': 'Ukraine',
            '036': 'Australia',
            '250': 'France',
            '356': 'India',
            '360': 'Indonesia',
            '410': 'South Korea',
            '458': 'Malaysia',
            '484': 'Mexico',
            '643': 'Russia',
            '764': 'Thailand',
            '704': 'Vietnam',
            '496': 'Mongolia',
            '608': 'Philippines',
            '418': 'Laos',
            '104': 'Myanmar',
            '116': 'Cambodia',
            '096': 'Brunei',
            '398': 'Kazakhstan',
            '795': 'Turkmenistan',
            '860': 'Uzbekistan',
            '762': 'Tajikistan',
            '417': 'Kyrgyzstan',
            '051': 'Armenia',
            '031': 'Azerbaijan',
            '268': 'Georgia',
            '368': 'Iraq',
            '364': 'Iran',
            '682': 'Saudi Arabia',
            '784': 'United Arab Emirates',
            '634': 'Qatar',
            '414': 'Kuwait',
            '512': 'Oman',
            '887': 'Yemen',
            '760': 'Syria',
            '422': 'Lebanon',
            '400': 'Jordan',
            '376': 'Israel',
            '586': 'Pakistan',
            '004': 'Afghanistan',
            '050': 'Bangladesh',
            '144': 'Sri Lanka',
            '524': 'Nepal',
            '203': 'Czech Republic',
            '348': 'Hungary',
            '616': 'Poland',
            '040': 'Austria',
            '380': 'Italy',
            '756': 'Switzerland',
            '724': 'Spain',
            '620': 'Portugal',
            '056': 'Belgium',
            '528': 'Netherlands',
            '578': 'Norway',
            '752': 'Sweden',
            '246': 'Finland',
            '208': 'Denmark',
            '372': 'Ireland',
            '300': 'Greece',
            '642': 'Romania',
            '100': 'Bulgaria',
            '191': 'Croatia',
            '705': 'Slovenia',
            '440': 'Lithuania',
            '428': 'Latvia',
            '233': 'Estonia',
            '112': 'Belarus',
            '710': 'South Africa',
            '404': 'Kenya',
            '231': 'Ethiopia',
            '818': 'Egypt',
            '504': 'Morocco',
            '788': 'Tunisia',
            '012': 'Algeria',
            '288': 'Ghana',
            '566': 'Nigeria',
            '032': 'Argentina',
            '076': 'Brazil',
            '170': 'Colombia',
            '604': 'Peru',
            '152': 'Chile',
            '862': 'Venezuela',
            '218': 'Ecuador',
            '068': 'Bolivia',
            '600': 'Paraguay',
            '858': 'Uruguay'
    };

        // 定義所有規則
        const allRules = [
            { id: '1', text: '小金額且設備低風險', level: 'success', description: '交易金額低於500元且來自已知安全設備，可自動通過', 
              condition: function(tx) { return tx.amount < 500 && tx.deviceRisk > 0.2; }, 
              action: 'APPROVE' },
            { id: '2', text: '1天內驗證成功，累積金額小於$1000', level: 'success', description: '用戶在過去24小時內已經完成驗證，且累積交易金額低於1000元', 
              condition: function(tx) { return tx.isVerified && tx.cumulativeAmount < 1000 && isWithin24Hours(tx.timestamp); }, 
              action: 'APPROVE' },
            { id: '3', text: '設備中風險', level: 'warning', description: '使用者的設備風險評分在0至0.5之間，建議額外監控', 
              condition: function(tx) { return tx.deviceRisk >= 0 && tx.deviceRisk <= 0.5; }, 
              action: 'REVIEW' },
            { id: '4', text: '中高金額', level: 'warning', description: '單筆交易金額超過300元，需要額外審核', 
              condition: function(tx) { return tx.amount > 300; }, 
              action: 'REVIEW' },
            { id: '5', text: '中高金額且來自高風險國家', level: 'danger', description: '偵測交易金額超過500元且來源IP位於高風險國家清單中的交易', 
              condition: function(tx) { return tx.amount > 500 && (tx.countryCode === '408' || tx.countryCode === '804'); }, 
              action: 'BLOCK' },
            { id: '6', text: '設備高風險', level: 'danger', description: '設備風險評分為負數，可能表示有異常活動', 
              condition: function(tx) { return tx.deviceRisk < 0; }, 
              action: 'BLOCK' },
            { id: '7', text: '短時間內來自不同國家', level: 'danger', description: '偵測同一卡號在60分鐘內從不同國家發起交易，可能為盜刷', 
              condition: function(tx) { return hasMultipleCountriesIn60Min(tx, transactions); }, 
              action: 'BLOCK' }
        ];
        
        // 預設規則ID列表（按優先順序）
        const defaultRuleIds = ['7', '5', '6', '4', '3'];
        
        // 檢查是否在過去24小時內
        function isWithin24Hours(timestamp) {
            const now = new Date();
            const txTime = new Date(timestamp);
            const hoursDiff = (now - txTime) / (1000 * 60 * 60);
            return hoursDiff <= 24;
        }
        
        // 檢查是否在60分鐘內有來自不同國家的交易
        function hasMultipleCountriesIn60Min(transaction, allTransactions) {
            const card = transaction.card;
            const txTime = new Date(transaction.timestamp);
            const countriesInTimeWindow = new Set();
            
            // 收集60分鐘內所有交易的國家
            allTransactions.forEach(function(tx) {
                if (tx.card === card) {
                    const otherTxTime = new Date(tx.timestamp);
                    const minutesDiff = Math.abs((txTime - otherTxTime) / (1000 * 60));
                    
                    if (minutesDiff <= 60) {
                        countriesInTimeWindow.add(tx.countryCode);
                    }
                }
            });
            
            // 如果有多個國家則返回真
            return countriesInTimeWindow.size > 1;
        }
        
        // 生成隨機時間
        function getRandomTime(minHoursAgo, maxHoursAgo) {
            minHoursAgo = minHoursAgo || 0;
            maxHoursAgo = maxHoursAgo || 48;
            const now = new Date();
            const hoursAgo = Math.random() * (maxHoursAgo - minHoursAgo) + minHoursAgo;
            const timestamp = new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);
            return timestamp;
        }
        
        // 格式化日期時間
        function formatDateTime(date) {
            return date.toLocaleString('zh-TW', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        // 交易數據
        const transactions = generateTransactions(200);

        function generateTransactions(count) {
            const transactions = [];
            const countryCodes = Object.keys(countryMap);
            
            // 確保台灣的代碼存在於國家列表中
            if (!countryCodes.includes('158')) {
                countryCodes.push('158'); // 添加台灣的ISO代碼
            }
            
            const deviceRiskLevels = [-0.9, -0.8, -0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
            
            // 定義常見的銀行卡前綴
            const bankCardPrefixes = ['4', '5', '3', '6']; // 模擬 Visa, Mastercard, Amex, UnionPay 等
            
            // 產生一些有跨國交易的卡號
            const crossBorderCards = [];
            for (let i = 0; i < 20; i++) {
                const prefix = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)];
                const randomDigits = Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0'); // 生成15位隨機數字
                crossBorderCards.push(prefix + randomDigits); // 例如 4477578712345678
            }
            
            // 確保交易金額有不同級別
            const amountRanges = [
                { min: 10, max: 300 },
                { min: 301, max: 800 },
                { min: 801, max: 2000 },
                { min: 2001, max: 10000 }
            ];
            
            // 生成交易
            for (let i = 0; i < count; i++) {
                const isCrossBorder = Math.random() < 0.15; // 15%的跨國交易
                let card;
                
                if (isCrossBorder) {
                    // 使用跨國卡號
                    card = crossBorderCards[Math.floor(Math.random() * crossBorderCards.length)];
                } else {
                    // 生成普通卡號（16位數字，模擬銀行卡前綴 + 隨機數字）
                    const prefix = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)];
                    const randomDigits = Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0'); // 生成15位隨機數字
                    card = prefix + randomDigits; // 例如 4477578712345678
                }
                
                // 選擇金額範圍
                const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;
                
                // 選擇國家 (確保台灣有一定比例)
                let countryCode;
                if (Math.random() < 0.1) { // 10%的機率選擇台灣
                    countryCode = '158'; // 台灣
                } else {
                    countryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                }
                
                // 設備風險
                const deviceRisk = deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)];
                
                // 驗證狀態 (75% 已驗證)
                const isVerified = Math.random() < 0.75;
                
                // 累積金額 (根據卡號模擬一些累積)
                let cumulativeAmount = amount;
                if (Math.random() < 0.4) {
                    cumulativeAmount += Math.floor(Math.random() * 3000);
                }
                
                // 時間 (分布在過去48小時內)
                const timestamp = getRandomTime(0, 48);
                
                // 創建交易對象
                const transaction = {
                    id: i + 1,
                    card: card,
                    countryCode: countryCode,
                    amount: amount,
                    deviceRisk: deviceRisk,
                    isVerified: isVerified,
                    cumulativeAmount: cumulativeAmount,
                    timestamp: timestamp
                };
                
                transactions.push(transaction);
            }
            
            // 為跨國交易卡添加同一時間段內的多國交易
            for (const crossCard of crossBorderCards) {
                const cardTransactions = transactions.filter(tx => tx.card === crossCard);
                
                if (cardTransactions.length > 0) {
                    const baseTx = cardTransactions[0];
                    const baseTime = new Date(baseTx.timestamp);
                    const newTime = new Date(baseTime.getTime() + Math.random() * 55 * 60 * 1000); // 55分鐘內
                    
                    let newCountryCode;
                    if (baseTx.countryCode !== '158' && Math.random() < 0.2) {
                        newCountryCode = '158'; // 台灣
                    } else {
                        do {
                            newCountryCode = countryCodes[Math.floor(Math.random() * countryCodes.length)];
                        } while (newCountryCode === baseTx.countryCode);
                    }
                    
                    transactions.push({
                        id: transactions.length + 1,
                        card: crossCard,
                        countryCode: newCountryCode,
                        amount: Math.floor(Math.random() * 1000) + 100,
                        deviceRisk: baseTx.deviceRisk,
                        isVerified: baseTx.isVerified,
                        cumulativeAmount: baseTx.cumulativeAmount + Math.floor(Math.random() * 500),
                        timestamp: newTime
                    });
                }
            }
            
            // 確保至少有一些台灣的交易記錄
            const taiwanTxCount = transactions.filter(tx => tx.countryCode === '158').length;
            if (taiwanTxCount < 5) {
                const additionalCount = 5 - taiwanTxCount;
                for (let i = 0; i < additionalCount; i++) {
                    const prefix = bankCardPrefixes[Math.floor(Math.random() * bankCardPrefixes.length)];
                    const randomDigits = Math.floor(100000000000000 + Math.random() * 900000000000000).toString().padStart(15, '0'); // 生成15位隨機數字
                    const card = prefix + randomDigits; // 例如 4477578712345678
                    
                    const amountRange = amountRanges[Math.floor(Math.random() * amountRanges.length)];
                    const amount = Math.floor(Math.random() * (amountRange.max - amountRange.min + 1)) + amountRange.min;
                    
                    transactions.push({
                        id: transactions.length + 1,
                        card: card,
                        countryCode: '158', // 台灣
                        amount: amount,
                        deviceRisk: deviceRiskLevels[Math.floor(Math.random() * deviceRiskLevels.length)],
                        isVerified: Math.random() < 0.75,
                        cumulativeAmount: amount + (Math.random() < 0.4 ? Math.floor(Math.random() * 3000) : 0),
                        timestamp: getRandomTime(0, 48)
                    });
                }
            }
            
            return transactions;
        }

        function loadTransactions() {
            transactionTable.innerHTML = '';
            
            transactions.forEach(function(tx) {
                const row = document.createElement('tr');
                row.setAttribute('data-id', tx.id);
                
                // 驗證卡號長度並顯示前8位，後8位掩碼為********
                let displayCard;
                if (tx.card.length === 16) {
                    displayCard = tx.card.substring(0, 8) + '********';
                } else {
                    // 如果卡號長度不正確，記錄錯誤並顯示全掩碼
                    console.warn(`Invalid card length for transaction ${tx.id}: ${tx.card}`);
                    displayCard = '****************';
                }
                
                row.innerHTML = 
                    '<td><i class="fas fa-circle-notch fa-spin text-secondary"></i></td>' +
                    '<td class="font-monospace">' + displayCard + '</td>' +
                    '<td>' + formatDateTime(tx.timestamp) + '</td>' +
                    '<td>' + (countryMap[tx.countryCode] || tx.countryCode) + '</td>' +
                    '<td class="text-end">' + tx.amount.toLocaleString() + '</td>' +
                    '<td class="text-end"><span class="risk-badge ' + 
                    (tx.deviceRisk > 0.3 ? 'success' : tx.deviceRisk >= 0 ? 'warning' : 'danger') + 
                    '">' + tx.deviceRisk.toFixed(1) + '</span></td>' +
                    '<td></td>';
                
                transactionTable.appendChild(row);
            });
        }


        // DOM元素
        var executionZone, availableRules, placeholder, dropIndicator, defaultBtn, customBtn, transactionTable, logPanel;
        
        // ECharts 世界地圖相關代碼
        let worldMap;
                
        // 初始化
        window.onload = function() {
            executionZone = document.getElementById('execution-zone');
            availableRules = document.getElementById('available-rules');
            placeholder = document.getElementById('zone-placeholder');
            dropIndicator = document.getElementById('drop-indicator');
            defaultBtn = document.getElementById('default-btn');
            customBtn = document.getElementById('custom-btn');
            transactionTable = document.getElementById('transaction-table');
            logPanel = document.getElementById('log-panel');
            
            initializeRules();
            loadTransactions();
            applyDefaultRules();
            
            // 初始化世界地圖
            initWorldMap();
    
        };
        
        
    
    // 更新世界地圖的交易資料 - 修改為顯示高風險交易數量
    function updateWorldMap() {
    if (!worldMap) {
        console.error('地圖未初始化');
        return;
    }
    
    // 檢查地圖是否已成功註冊
    if (!echarts.getMap('world')) {
        console.error('世界地圖數據尚未完全加載');
        addLog('地圖數據尚未完全載入，無法更新');
        return;
    }
    
    // 顯示更新中狀態
    worldMap.showLoading({
        text: '更新地圖數據...',
        maskColor: 'rgba(255, 255, 255, 0.5)',
        textColor: '#1890ff'
    });
    
    try {
        // 統計每個國家的交易數量和高風險交易數量
        const countryCounts = {};
        const countryHighRiskCounts = {};
        
        // 獲取執行過風險規則的交易
        const rows = document.querySelectorAll('#transaction-table tr');
        
        rows.forEach(function(row) {
            const txId = row.getAttribute('data-id');
            if (!txId) return;
            
            const tx = transactions.find(t => t.id == txId);
            if (!tx) return;
            
            // 檢查交易狀態 - 是否為高風險
            const statusIcon = row.querySelector('td:first-child i');
            let isHighRisk = false;
            
            if (statusIcon && statusIcon.classList.contains('text-danger')) {
                isHighRisk = true;
            }
            
            // 累計數量和高風險交易
            if (!countryCounts[tx.countryCode]) {
                countryCounts[tx.countryCode] = 0;
                countryHighRiskCounts[tx.countryCode] = 0;
            }
            
            countryCounts[tx.countryCode]++;
            if (isHighRisk) {
                countryHighRiskCounts[tx.countryCode]++;
            }
        });
        
        // 格式化 ECharts 資料
        const mapData = Object.keys(countryCounts).map(function(code) {
            // 獲取國家的ECharts名稱
            const echartsName = countryEChartsMap[code];
            const totalCount = countryCounts[code];
            const highRiskCount = countryHighRiskCounts[code];
            
            // 如果找不到對應，使用ISO數字代碼
            return {
                name: echartsName || code,
                value: highRiskCount,  // 使用高風險交易數量作為值
                totalCount: totalCount,
                highRiskCount: highRiskCount,
                highRiskPercentage: totalCount > 0 ? Math.round((highRiskCount / totalCount) * 100) : 0,
                // 儲存原始代碼用於提示框
                originalCode: code
            };
        });
        
        // 找出最大的高風險交易數量，至少為1
        const maxHighRiskCount = Math.max(...Object.values(countryHighRiskCounts), 1);
        
        // 地圖配置
        const option = {
            backgroundColor: '#fff',
            title: {
                text: '交易高風險地區分佈',
                subtext: '顏色深淺代表高風險交易數量',
                left: 'center',
                top: 10
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.data && params.data.originalCode) {
                        const countryCode = params.data.originalCode;
                        const localName = countryMap[countryCode] || countryCode;
                        const totalCount = params.data.totalCount;
                        const highRiskCount = params.data.highRiskCount;
                        const highRiskPercentage = params.data.highRiskPercentage;
                        
                        return `${localName}<br/>
                                總交易數量: ${totalCount} 筆<br/>
                                高風險交易: ${highRiskCount} 筆<br/>
                                高風險比例: ${highRiskPercentage}%`;
                    }
                    return params.name;
                }
            },
            visualMap: {
                show: true,
                min: 0,
                max: maxHighRiskCount,
                calculable: true,
                inRange: {
                    color: ['#fee2e2', '#ef4444']  // 從淺紅到深紅
                },
                text: ['高風險交易多', '高風險交易少'],
                left: 'left',
                top: 'bottom',
                textStyle: {
                    color: '#333'
                }
            },
            series: [
                {
                    name: '高風險交易',
                    type: 'map',
                    map: 'world',
                    aspectScale: 0.75,
                    roam: true,
                    zoom: 1.2,
                    selectedMode: false,
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 10,
                            color: '#333'
                        },
                        itemStyle: {
                            areaColor: '#fecaca'
                        }
                    },
                    data: mapData,
                    itemStyle: {
                        areaColor: '#f5f5f5',
                        borderColor: '#ccc',
                        borderWidth: 0.5
                    }
                }
            ]
        };
        
        // 設定配置並渲染
        worldMap.setOption(option);
        worldMap.hideLoading();
        
        addLog('地圖更新完成: 顯示 ' + mapData.length + ' 個國家的高風險交易資料');
    } catch (error) {
        console.error('更新地圖時發生錯誤:', error);
        worldMap.hideLoading();
        addLog('地圖更新失敗: ' + error.message);
    }
}

    // 初始化世界地圖
    function initWorldMap() {
        const chartDom = document.getElementById('world-map');
        if (!chartDom) return;
        
        // 初始化ECharts實例
        worldMap = echarts.init(chartDom);
        
        // 顯示加載中狀態
        worldMap.showLoading({
            text: '加載世界地圖數據中...',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            textColor: '#1890ff'
        });
        
        // 註冊世界地圖
        fetch('./wMap.json')  // 使用相對路徑指向你存放的位置
        .then(response => {
            if (!response.ok) {
                throw new Error('無法獲取地圖數據: ' + response.statusText);
            }
            return response.json();
        })
        .then(worldJson => {
            // 地圖數據加載成功
            echarts.registerMap('world', worldJson);
            worldMap.hideLoading();
            addLog('世界地圖數據加載成功');
            
            // 嘗試設置初始地圖視圖
            try {
                setInitialMapView();
            } catch(e) {
                console.error('設置初始視圖失敗:', e);
                addLog('初始視圖設置失敗，但地圖已加載');
            }
        })
        .catch(error => {
            addLog('加載地圖數據失敗: ' + error.message);
            // 可以提供一個備用選項或顯示錯誤信息
        });
        
        // 處理視窗大小調整
        window.addEventListener('resize', function() {
            if (worldMap) {
                worldMap.resize();
            }
        });
    }

    // 設置初始地圖視圖 (如果這個函數不存在，可以添加一個空函數)
    function setInitialMapView() {
        if (worldMap) {
            worldMap.setOption({
                series: [{
                    center: [0, 30],
                    zoom: 1.2
                }]
            });
        }
    }
        // 初始化所有規則
        function initializeRules() {
            availableRules.innerHTML = '';
            allRules.forEach(function(rule) {
                addRuleToAvailable(rule);
            });
        }
        
        // 顯示規則描述
        function showDescription(element) {
            const description = element.getAttribute('data-description');
            document.getElementById('rule-description').textContent = description;
        }
        
        // 添加規則到可用區域
        function addRuleToAvailable(rule) {
            if (document.querySelector('#available-rules [data-id="' + rule.id + '"]')) {
                return;
            }
            
            const ruleElement = document.createElement('div');
            ruleElement.className = 'rule-item ' + rule.level;
            ruleElement.draggable = true;
            ruleElement.setAttribute('ondragstart', 'dragStart(event)');
            ruleElement.setAttribute('data-id', rule.id);
            ruleElement.setAttribute('data-level', rule.level);
            ruleElement.setAttribute('data-description', rule.description);
            ruleElement.setAttribute('onmouseenter', 'showDescription(this)');
            
            ruleElement.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<div class="rule-number">' + rule.id + '</div>' +
                    '<div class="rule-icon ' + rule.level + '">' +
                    '<i class="fas fa-' + (rule.level === 'success' ? 'check' : rule.level === 'warning' ? 'exclamation-triangle' : 'exclamation-circle') + '"></i>' +
                    '</div>' +
                    '<span>' + rule.text + '</span>' +
                '</div>' +
                '<div class="rule-actions">' +
                    '<i class="fas fa-arrows-alt handle"></i>' +
                '</div>';
            
            availableRules.appendChild(ruleElement);
        }
        
        // 創建規則克隆（用於執行區域）
        function createRuleClone(rule) {
            let ruleId, ruleLevel, ruleDescription, ruleText;
            
            if (rule instanceof Element) {
                ruleId = rule.getAttribute('data-id');
                ruleLevel = rule.getAttribute('data-level');
                ruleDescription = rule.getAttribute('data-description');
                ruleText = rule.querySelector('.d-flex span').textContent;
            } else {
                ruleId = rule.id;
                ruleLevel = rule.level;
                ruleDescription = rule.description;
                ruleText = rule.text;
            }
            
            const clone = document.createElement('div');
            clone.className = 'rule-item ' + ruleLevel;
            clone.draggable = true;
            clone.setAttribute('ondragstart', 'dragStart(event)');
            clone.setAttribute('data-id', ruleId);
            clone.setAttribute('data-level', ruleLevel);
            clone.setAttribute('data-description', ruleDescription);
            clone.setAttribute('onmouseenter', 'showDescription(this)');
            
            clone.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<div class="rule-number">' + ruleId + '</div>' +
                    '<div class="rule-icon ' + ruleLevel + '">' +
                    '<i class="fas fa-' + (ruleLevel === 'success' ? 'check' : ruleLevel === 'warning' ? 'exclamation-triangle' : 'exclamation-circle') + '"></i>' +
                    '</div>' +
                    '<span>' + ruleText + '</span>' +
                '</div>' +
                '<div class="rule-actions">' +
                    '<i class="fas fa-arrows-alt handle"></i>' +
                    '<button class="btn-action" onclick="removeRule(this.parentNode.parentNode)">' +
                    '<i class="fas fa-times"></i>' +
                    '</button>' +
                '</div>';
            
            return clone;
        }
        
        // 拖動開始處理
        function dragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.getAttribute('data-id'));
            event.target.style.opacity = '0.4';
        }
        
        // 允許放置
        function allowDrop(event) {
            event.preventDefault();
            showDropIndicator(event);
        }
        
        // 顯示放置指示器
        function showDropIndicator(event) {
            const executionItems = Array.from(executionZone.children).filter(function(child) {
                return child.classList.contains('rule-item');
            });
            
            if (executionItems.length === 0) {
                executionZone.insertBefore(dropIndicator, placeholder);
                dropIndicator.classList.add('active');
                return;
            }
            
            let closestItem = null;
            let closestDistance = Number.MAX_VALUE;
            let position = 'before';
            
            executionItems.forEach(function(item) {
                const rect = item.getBoundingClientRect();
                const itemMiddle = rect.top + rect.height / 2;
                const distance = Math.abs(event.clientY - itemMiddle);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                    position = event.clientY < itemMiddle ? 'before' : 'after';
                }
            });
            
            if (closestItem) {
                if (position === 'before') {
                    executionZone.insertBefore(dropIndicator, closestItem);
                } else {
                    executionZone.insertBefore(dropIndicator, closestItem.nextSibling);
                }
                dropIndicator.classList.add('active');
            }
        }
        
        // 放置處理
        function drop(event) {
            event.preventDefault();
            
            dropIndicator.classList.remove('active');
            
            const ruleId = event.dataTransfer.getData('text/plain');
            const sourceRule = document.querySelector('[data-id="' + ruleId + '"]');
            
            if (!sourceRule) return;
            
            sourceRule.style.opacity = '';
            
            const isFromAvailable = sourceRule.parentNode.id === 'available-rules';
            
            if (isFromAvailable) {
                const rule = allRules.find(function(r) { return r.id === ruleId; });
                if (!rule) return;
                
                const newRule = createRuleClone(rule);
                const insertBefore = dropIndicator.nextSibling || placeholder;
                executionZone.insertBefore(newRule, insertBefore);
                
                sourceRule.remove();
            } else {
                const insertBefore = dropIndicator.nextSibling || placeholder;
                executionZone.insertBefore(sourceRule, insertBefore);
            }
            
            updatePlaceholder();
            updateButtonState();
        }
        
        // 移除規則
        function removeRule(rule) {
            const ruleId = rule.getAttribute('data-id');
            
            const originalRule = allRules.find(function(r) { return r.id === ruleId; });
            if (originalRule) {
                addRuleToAvailable(originalRule);
                rule.remove();
                
                updatePlaceholder();
                updateButtonState();
            }
        }
        
        // 更新佔位符顯示
        function updatePlaceholder() {
            const hasRules = executionZone.querySelectorAll('.rule-item').length > 0;
            placeholder.style.display = hasRules ? 'none' : 'block';
        }
        
        // 更新按鈕狀態
        function updateButtonState() {
            const currentRules = Array.from(
                executionZone.querySelectorAll('.rule-item')
            ).map(function(rule) { 
                return rule.getAttribute('data-id'); 
            });
            
            const isDefault = isDefaultConfiguration(currentRules);
            
            defaultBtn.classList.toggle('active', isDefault);
            customBtn.classList.toggle('active', !isDefault);
        }
        
        // 檢查是否為預設配置
        function isDefaultConfiguration(currentRules) {
            if (currentRules.length !== defaultRuleIds.length) return false;
            
            for (let i = 0; i < defaultRuleIds.length; i++) {
                if (currentRules[i] !== defaultRuleIds[i]) return false;
            }
            
            return true;
        }
        
        // 應用預設規則
        function applyDefaultRules() {
            clearRules();
            
            defaultRuleIds.forEach(function(id) {
                const rule = allRules.find(function(r) { return r.id === id; });
                if (rule) {
                    const newRule = createRuleClone(rule);
                    executionZone.insertBefore(newRule, placeholder);
                    
                    const availableRule = document.querySelector('#available-rules [data-id="' + id + '"]');
                    if (availableRule) {
                        availableRule.remove();
                    }
                }
            });
            
            updatePlaceholder();
            updateButtonState();
        }
        
        // 清空所有規則
        function clearRules() {
            const executionRules = executionZone.querySelectorAll('.rule-item');
            executionRules.forEach(function(rule) {
                const ruleId = rule.getAttribute('data-id');
                rule.remove();
                
                const originalRule = allRules.find(function(r) { return r.id === ruleId; });
                if (originalRule) {
                    addRuleToAvailable(originalRule);
                }
            });
            
            updatePlaceholder();
            
            // 重置交易狀態
            resetTransactionStatus();
        }
        
        // 重置交易狀態
        function resetTransactionStatus() {
            const transactionRows = transactionTable.querySelectorAll('tr');
            
            transactionRows.forEach(function(row) {
                const statusCell = row.querySelector('td:first-child');
                const hitRuleCell = row.querySelector('td:last-child');
                
                statusCell.innerHTML = '<i class="fas fa-circle-notch fa-spin text-secondary"></i>';
                hitRuleCell.textContent = '';
                
                row.classList.remove('highlighted');
            });
        }
        
        // 添加日誌
        // function addLog(message) {
        //     const logEntry = document.createElement('div');
        //     logEntry.textContent = '> ' + message;
        //     logPanel.appendChild(logEntry);
        //     logPanel.scrollTop = logPanel.scrollHeight;
        // }

        function addLog(message) {
            if (!logPanel) {
                console.warn('logPanel is not initialized yet: ' + message);
                return;
            }
            const logEntry = document.createElement('div');
            logEntry.textContent = '> ' + message;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        
        
        
        // 清空日誌
        function clearLog() {
            logPanel.innerHTML = '';
        }
        
        // 執行規則引擎
        function executeRules() {
            clearLog();
            resetTransactionStatus();
            
            const activeRuleElements = executionZone.querySelectorAll('.rule-item');
            const riskLevel = document.getElementById('risk-level').value;
            
            addLog('風險等級設置為: ' + riskLevel);
            
            if (activeRuleElements.length === 0) {
                addLog('沒有可用規則，所有交易設為' + riskLevel + '風險');
                
                // 處理沒有規則時的預設行為
                transactions.forEach(function(tx) {
                    const row = document.querySelector('#transaction-table tr[data-id="' + tx.id + '"]');
                    const statusCell = row.querySelector('td:first-child');
                    const hitRuleCell = row.querySelector('td:last-child');
                    
                    hitRuleCell.textContent = '未命中任何規則';
                    
                    // 根據風險等級決定未命中規則的交易處理方式
                    if (riskLevel === 'low') {
                        statusCell.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    } else if (riskLevel === 'medium') {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                    } else if (riskLevel === 'high') {
                        statusCell.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                    }
                    
                    row.classList.add('highlighted');
                });
                
                updateWorldMap();
                return;
            }
            
            // 獲取當前活動規則
            const activeRules = Array.from(activeRuleElements).map(function(ruleElement) {
                const ruleId = ruleElement.getAttribute('data-id');
                return allRules.find(function(r) { return r.id === ruleId; });
            }).filter(function(rule) { return rule !== undefined; });
            
            // 處理每個交易
            transactions.forEach(function(tx) {
                processTransaction(tx, activeRules, riskLevel);
            });
            
            // 更新世界地圖
            updateWorldMap();
        }
        
        // 處理單筆交易
        function processTransaction(transaction, activeRules, riskLevel) {
            const row = document.querySelector('#transaction-table tr[data-id="' + transaction.id + '"]');
            const statusCell = row.querySelector('td:first-child');
            const hitRuleCell = row.querySelector('td:last-child');
            
            let matchedRule = null;
            // 初始動作根據風險等級設置
            let action = getDefaultActionByRiskLevel(riskLevel);
            
            // 依序執行規則
            for (let i = 0; i < activeRules.length; i++) {
                const rule = activeRules[i];
                if (rule.condition(transaction)) {
                    matchedRule = rule;
                    action = rule.action;
                    
                    // 基於風險等級調整行動
                    // if (riskLevel === 'low' && action === 'BLOCK') {
                    //     action = 'REVIEW';
                    // } else if (riskLevel === 'high' && action === 'APPROVE') {
                    //     action = 'REVIEW';
                    // }
                    
                    // 記錄命中的規則
                    hitRuleCell.innerHTML = '<span class="badge bg-light text-dark">#' + rule.id + '</span> ' + rule.text;
                    addLog('交易 ' + transaction.card + ' 命中規則 #' + rule.id + ': ' + rule.text);
                    
                    break; // 找到第一個符合的規則就停止
                }
            }
            
            // 更新交易狀態
            if (action === 'APPROVE') {
                statusCell.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                row.classList.add('highlighted');
            } else if (action === 'REVIEW') {
                statusCell.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                row.classList.add('highlighted');
            } else if (action === 'BLOCK') {
                statusCell.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
                row.classList.add('highlighted');
            } else {
                statusCell.innerHTML = '<i class="fas fa-question-circle text-secondary"></i>';
            }
            
            // 沒有命中規則的情況
            if (!matchedRule) {
                hitRuleCell.textContent = '未命中任何規則';
                addLog('交易 ' + transaction.card + ' 未命中任何規則，採用' + riskLevel + '風險預設行為');
            }
        }
        
        // 根據風險等級獲取預設行為
        function getDefaultActionByRiskLevel(riskLevel) {
            switch(riskLevel) {
                case 'low':
                    return 'APPROVE';
                case 'medium':
                    return 'REVIEW';
                case 'high':
                    return 'BLOCK';
                default:
                    return 'REVIEW';
            }
        }
        // 初始化世界地圖
function initWorldMap() {
    const chartDom = document.getElementById('world-map');
    if (!chartDom) return;
    
    // 初始化ECharts實例
    worldMap = echarts.init(chartDom);
    
    // 顯示加載中狀態
    worldMap.showLoading({
        text: '加載世界地圖數據中...',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        textColor: '#1890ff'
    });
    
    // 註冊世界地圖
    fetch('./wMap.json')  // 使用相對路徑指向你存放的位置
    .then(response => {
        if (!response.ok) {
        throw new Error('無法獲取地圖數據: ' + response.statusText);
        }
        return response.json();
    })
    .then(worldJson => {
        // 地圖數據加載成功
        echarts.registerMap('world', worldJson);
        worldMap.hideLoading();
        addLog('世界地圖數據加載成功');
        // 初始地圖視圖
        setInitialMapView();
    })
    .catch(error => {
        addLog('加載地圖數據失敗: ' + error.message);
        // 可以提供一個備用選項或顯示錯誤信息
    });
    
    // 處理視窗大小調整
    window.addEventListener('resize', function() {
        if (worldMap) {
            worldMap.resize();
        }
    });
}
// 直接在控制台執行此代碼即可添加並初始化時間風險圖表

// 添加圖表容器
const timeChartCard = document.createElement('div');
timeChartCard.className = 'card mt-3';
timeChartCard.innerHTML = `
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">交易風險時間分佈</h5>
            <div class="text-muted small">各時段風險交易數量統計</div>
        </div>
        <div id="hourly-risk-chart" style="height: 400px; width: 100%;"></div>
    </div>
`;

// 找到合適的位置插入圖表
const mapCard = document.querySelector('.row:has(#world-map)');
if (mapCard) {
    mapCard.after(timeChartCard);
} else {
    // 備用選項：添加到容器末尾
    document.querySelector('.container-fluid').appendChild(timeChartCard);
}

// 初始化圖表
const chartDom = document.getElementById('hourly-risk-chart');
const hourlyRiskChart = echarts.init(chartDom);

// 顯示加載中狀態
hourlyRiskChart.showLoading({
    text: '加載交易數據中...',
    maskColor: 'rgba(255, 255, 255, 0.8)',
    textColor: '#1890ff'
});

// 函數：分析交易風險時間分布
function analyzeHourlyRiskDistribution() {
    // 初始化每小時的風險計數
    const hourlyData = Array.from({ length: 24 }, () => ({
        low: 0,
        medium: 0,
        high: 0,
        total: 0
    }));
    
    // 獲取所有交易行
    const rows = document.querySelectorAll('#transaction-table tr');
    
    // 統計每小時的風險分布
    rows.forEach(row => {
        const txId = row.getAttribute('data-id');
        if (!txId) return;
        
        const tx = transactions.find(t => t.id == txId);
        if (!tx) return;
        
        // 獲取交易時間的小時數
        const txTime = new Date(tx.timestamp);
        const hour = txTime.getHours();
        
        // 獲取風險級別
        const statusIcon = row.querySelector('td:first-child i');
        let riskLevel = 'medium'; // 預設中風險
        
        if (statusIcon) {
            if (statusIcon.classList.contains('text-success')) {
                riskLevel = 'low';
            } else if (statusIcon.classList.contains('text-warning')) {
                riskLevel = 'medium';
            } else if (statusIcon.classList.contains('text-danger')) {
                riskLevel = 'high';
            }
        }
        
        // 增加計數
        hourlyData[hour][riskLevel]++;
        hourlyData[hour].total++;
    });
    
    return hourlyData;
}

// 函數：更新圖表
function updateHourlyRiskChart() {
    // 分析數據
    const hourlyRiskData = analyzeHourlyRiskDistribution();
    
    // 提取圖表數據
    const xAxisData = Array.from({ length: 24 }, (_, i) => `${i}:00`);
    const lowRiskData = hourlyRiskData.map(h => h.low);
    const mediumRiskData = hourlyRiskData.map(h => h.medium);
    const highRiskData = hourlyRiskData.map(h => h.high);
    
    // 設置圖表配置
    const option = {
        title: {
            text: '各時段交易風險分佈',
            subtext: '按小時統計的不同風險等級交易數量',
            left: 'center',
            top: 10
        },
        legend: {
            data: ['低風險', '中風險', '高風險'],
            left: '10%',
            bottom: 10
        },
        toolbox: {
            feature: {
                saveAsImage: {},
                dataView: {}
            }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                let total = 0;
                let result = `${params[0].axisValueLabel}<br>`;
                
                params.forEach(param => {
                    total += param.value;
                    result += `${param.marker} ${param.seriesName}: ${param.value}<br>`;
                });
                
                result += `<b>總計: ${total}</b>`;
                return result;
            }
        },
        xAxis: {
            data: xAxisData,
            name: '小時',
            axisLine: { onZero: true },
            splitLine: { show: false },
            splitArea: { show: false }
        },
        yAxis: {
            name: '交易數量'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            top: '15%',
            containLabel: true
        },
        series: [
            {
                name: '低風險',
                type: 'bar',
                stack: '風險',
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.3)'
                    }
                },
                data: lowRiskData,
                itemStyle: {
                    color: '#4CAF50' // 綠色
                }
            },
            {
                name: '中風險',
                type: 'bar',
                stack: '風險',
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.3)'
                    }
                },
                data: mediumRiskData,
                itemStyle: {
                    color: '#FFB300' // 黃色
                }
            },
            {
                name: '高風險',
                type: 'bar',
                stack: '風險',
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0,0,0,0.3)'
                    }
                },
                data: highRiskData,
                itemStyle: {
                    color: '#E57373' // 紅色
                }
            }
        ]
    };
    
    // 更新圖表
    hourlyRiskChart.setOption(option);
    hourlyRiskChart.hideLoading();
    
    // 添加日誌
    if (typeof addLog === 'function') {
        addLog('已更新風險時間分佈圖表');
    }
}

// 修改原始執行規則函數
const originalExecuteRules = window.executeRules;
window.executeRules = function() {
    // 先調用原始執行規則函數
    originalExecuteRules.apply(this, arguments);
    
    // 延遲更新圖表，確保交易狀態已更新
    setTimeout(updateHourlyRiskChart, 500);
};

// 處理窗口大小調整
window.addEventListener('resize', function() {
    if (hourlyRiskChart) {
        hourlyRiskChart.resize();
    }
});

// 立即執行首次更新
updateHourlyRiskChart();

// 添加日誌
if (typeof addLog === 'function') {
    addLog('風險時間分佈圖表已初始化，執行規則後會自動更新');
}




// 我是圓餅圖-------------------------
// 函數：分析交易風險分布
function analyzeRiskDistribution() {
    // 初始化風險計數
    const riskData = {
        high: 0,
        medium: 0,
        low: 0,
        total: 0
    };
    
    // 獲取所有交易行
    const rows = document.querySelectorAll('#transaction-table tr');
    
    // 統計風險分布
    rows.forEach(row => {
        const txId = row.getAttribute('data-id');
        if (!txId) return;
        
        // 獲取風險級別
        const statusIcon = row.querySelector('td:first-child i');
        if (!statusIcon) return;
        
        // 根據圖標類別判斷風險級別
        if (statusIcon.classList.contains('text-success')) {
            riskData.low++;
        } else if (statusIcon.classList.contains('text-warning')) {
            riskData.medium++;
        } else if (statusIcon.classList.contains('text-danger')) {
            riskData.high++;
        }
        
        riskData.total++;
    });
    
    return riskData;
}

// 函數：更新風險分布圓餅圖
function updateRiskPieChart() {
    // 獲取風險分布數據
    const riskData = analyzeRiskDistribution();
    
    // 添加日誌
    addLog(`風險分布分析: 高風險 ${riskData.high} 筆, 中風險 ${riskData.medium} 筆, 低風險 ${riskData.low} 筆, 總計 ${riskData.total} 筆`);
    
    // 圖表配置
    const option = {
        title: {
            text: '交易風險分布',
            subtext: `總計 ${riskData.total} 筆交易`,
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} 筆 ({d}%)'
        },
        legend: {
            orient: 'vertical',
            left: 'left',
            data: ['高風險', '中風險', '低風險']
        },
        series: [
            {
                name: '風險等級',
                type: 'pie',
                radius: '50%',
                data: [
                    { value: riskData.high, name: '高風險' },
                    { value: riskData.medium, name: '中風險' },
                    { value: riskData.low, name: '低風險' }
                ],
                itemStyle: {
                    color: function(params) {
                        const colorList = [
                            '#E57373', // 高風險 - 紅色
                            '#FFB300', // 中風險 - 黃色
                            '#4CAF50'  // 低風險 - 綠色
                        ];
                        return colorList[params.dataIndex];
                    }
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                },
                label: {
                    show: true,
                    formatter: '{b}: {c} 筆 ({d}%)'
                }
            }
        ]
    };
    
    return option;
}

// 添加到頁面
function addRiskPieChart() {
    // 創建圖表容器
    const pieChartCard = document.createElement('div');
    pieChartCard.className = 'card mt-3';
    pieChartCard.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title">交易風險分布</h5>
                <div class="text-muted small">各風險等級交易數量統計</div>
            </div>
            <div id="risk-pie-chart" style="height: 400px; width: 100%;"></div>
        </div>
    `;
    
    // 找到時間圖表插入後方
    const timeChartCard = document.querySelector('.card:has(#hourly-risk-chart)');
    if (timeChartCard) {
        timeChartCard.after(pieChartCard);
    } else {
        // 備用選項：添加到容器末尾
        document.querySelector('.container-fluid').appendChild(pieChartCard);
    }
    
    // 初始化圖表
    const chartDom = document.getElementById('risk-pie-chart');
    const riskPieChart = echarts.init(chartDom);
    
    // 顯示加載中狀態
    riskPieChart.showLoading({
        text: '分析交易數據中...',
        maskColor: 'rgba(255, 255, 255, 0.8)',
        textColor: '#1890ff'
    });
    
    // 更新圖表
    const option = updateRiskPieChart();
    riskPieChart.setOption(option);
    riskPieChart.hideLoading();
    
    // 處理窗口大小調整
    window.addEventListener('resize', function() {
        if (riskPieChart) {
            riskPieChart.resize();
        }
    });
    
    // 修改原始執行規則函數，加入圓餅圖更新
    const originalExecuteRules = window.executeRules;
    window.executeRules = function() {
        // 先調用原始執行規則函數
        originalExecuteRules.apply(this, arguments);
        
        // 延遲更新圖表，確保交易狀態已更新
        setTimeout(() => {
            const updatedOption = updateRiskPieChart();
            riskPieChart.setOption(updatedOption);
        }, 500);
    };
    
    addLog('風險分布圓餅圖已初始化，執行規則後會自動更新');
}

// 執行添加圖表
addRiskPieChart();
</script>
</body>
</html>